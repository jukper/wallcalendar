% Created 2020-10-03 Sat 14:01
% Intended LaTeX compiler: pdflatex
\documentclass[11pt,oneside]{memoir-article}
\usepackage{local}
\renewcommand{\docVersion}{v1.5.0}
\renewcommand{\docUrl}{\href{https://github.com/profound-labs/wallcalendar/}{link}}
\hypersetup{ pdfauthor={Gambhīro Bhikkhu}, }
\maxtocdepth{section}
\author{Gambhīro Bhikkhu}
\date{\today}
\title{Wallcalendar Code Documentation}
\hypersetup{
 pdfauthor={Gambhīro Bhikkhu},
 pdftitle={Wallcalendar Code Documentation},
 pdfkeywords={},
 pdfsubject={},
 pdfcreator={Emacs 28.0.50 (Org mode 9.3)}, 
 pdflang={English}}
\begin{document}

\maketitle

\chapter{Introduction}
\label{sec:orgeb2dca0}

\bigskip

This is the code documentation for the \texttt{wallcalendar} documentclass.

The \textbf{User Guide} is in \texttt{wallcalendar.pdf}. Clone or download from Github:

\href{https://github.com/profound-labs/wallcalendar/}{https://github.com/profound-labs/wallcalendar/}

\bigskip

\tableofcontents*

\clearpage

\chapter{Header}
\label{sec:org40837a7}

\begin{verbatim}
% wallcalendar.cls
%
% NOTE Don't edit this file directly. Edit doc/wallcalendar-code.org with emacs
% org-mode and run 'make wallcalendar.cls'.
%
% Wall Calendar
%
% A wall calendar document class with custom layouts and support for internationalization.
%
% (c) Gambhiro Bhikkhu, 2020
% gambhiro.bhikkhu.85@gmail.com
%
% LPPL LaTeX Public Project License
\end{verbatim}

\chapter{Identification}
\label{sec:org77b24b1}

\begin{verbatim}
\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{wallcalendar}[2020/10/02 v1.5.0 A wall calendar document class with custom layouts and support for internationalization.]
\end{verbatim}

\chapter{Preliminary Declarations}
\label{sec:org664a2a7}

\begin{verbatim}
\RequirePackage{pgfopts}
\RequirePackage{calc}

\newlength\calPaperWidth
\newlength\calPaperHeight
\newlength\calTextWidth
\newlength\calTextHeight
\newlength\@wall@leftMargin
\newlength\@wall@rightMargin
\newlength\@wall@topMargin
\newlength\@wall@bottomMargin
\newlength\@wall@trimSpace

\def\@wall@eventsCsv{}
\def\@wall@markDefaultsCsv{}
\def\@wall@translationsInputFile{}

\newcommand*\theMonthName{}
\end{verbatim}

\chapter{Options}
\label{sec:orgc46e3a4}

Paper sizes and ratios.

\begin{verbatim}
Choral Octavo = 6.75in x 10.5in = 171.45mm x 266.7mm , r = 1.5555
The calendar row is 40mm (without bleed) = 1.5748in
\end{verbatim}


\begin{verbatim}
When photo is above the calendar row, it has only three side bleed.
So aspect ratio:
(10.5in - 40mm + 3mm) / (6.75in + 6mm) = 
(266.7 - 40 + 3) / (171.45 + 6) =
= 1.2944
\end{verbatim}


\begin{verbatim}
\newif\ifvarnishmask
\newif\ifshowframe
\newif\iftranslationsAutoload
\newif\ifloadBabel
\newif\ifGridSurround

\pgfkeys{
  /wall/.is family, /wall,
  defaults/.style = {
    year = \the\year,
    altyear = \empty,
    loadBabel = false,
    language = english,
    translationsAutoload = true,
    imageFolder = {./src-images},
    choralOctavoPaper,
    hMargin = 17mm,
    topMargin = 20.5mm,
    bottomMargin = 10mm,
    trimSpace = 35mm,
  },
  year/.store in = \CalendarYear,
  year/.initial = \the\year,
  altyear/.store in = \CalendarAltYear,
  altyear/.initial = \empty,
  language/.store in = \@wall@calendarLanguage,
  loadBabel/.is if = loadBabel,
  translationsInputFile/.store in = \@wall@translationsInputFile,
  translationsInputFile/.initial = {},
  translationsAutoload/.is if = translationsAutoload,
  eventsCsv/.store in = \@wall@eventsCsv,
  eventsCsv/.initial = {},
  markDefaultsCsv/.store in = \@wall@markDefaultsCsv,
  markDefaultsCsv/.initial = {},
  varnishmask/.is if = varnishmask,
  showframe/.is if = showframe,
  gridSurround/.is if = GridSurround,
  imageFolder/.store in = \@wall@imageFolder,
  paperWidth/.code = {\setlength{\calPaperWidth}{#1}},
  paperHeight/.code = {\setlength{\calPaperHeight}{#1}},
  hMargin/.code = {\setlength{\@wall@leftMargin}{#1}%
		   \setlength{\@wall@rightMargin}{#1}},
  leftMargin/.code = {\setlength{\@wall@leftMargin}{#1}},
  rightMargin/.code = {\setlength{\@wall@rightMargin}{#1}},
  topMargin/.code = {\setlength{\@wall@topMargin}{#1}},
  bottomMargin/.code = {\setlength{\@wall@bottomMargin}{#1}},
  trimSpace/.code = {\setlength{\@wall@trimSpace}{#1}},
  % Paper sizes
  choralOctavoPaper/.style = {paperWidth = 6.75in, paperHeight = 10.5in},
  a2Paper/.style = {paperWidth = 420mm, paperHeight = 594mm},
  a2PaperLandscape/.style = {paperWidth = 594mm, paperHeight = 420mm},
  a3Paper/.style = {paperWidth = 297mm, paperHeight = 420mm},
  a3PaperLandscape/.style = {paperWidth = 420mm, paperHeight = 297mm},
  a4Paper/.style = {paperWidth = 210mm, paperHeight = 297mm},
  a4PaperLandscape/.style = {paperWidth = 297mm, paperHeight = 210mm},
  a5Paper/.style = {paperWidth = 148mm, paperHeight = 210mm},% r = 1.4142 = sqrt(2)
  prevPaper/.style = {paperWidth = 170mm, paperHeight = 250mm},% r = 1.4705
}

% Debug with: \wlog{YEA: \the\@wall@bottomMargin}

\DeclareOption*{%
  \PassOptionsToClass{\CurrentOption}{memoir}
}

\pgfkeys{/wall, defaults}
\ProcessPgfOptions{/wall}
\ProcessOptions\relax
\end{verbatim}

\chapter{More Declarations}
\label{sec:org6609f0a}
\section{Load memoir}
\label{sec:org59e85ba}

\begin{verbatim}
\LoadClass[11pt,oneside]{memoir}
\end{verbatim}

\section{Temp variables}
\label{sec:org726850b}

\begin{verbatim}
\newlength\@tmp@a
\newlength\@tmp@b
\newlength\@tmp@c
\newlength\@tmp@z
\newlength\@tmp@width
\newlength\@tmp@height
\end{verbatim}

\section{Require packages}
\label{sec:orgc669966}

\begin{verbatim}
\ifloadBabel
\RequirePackage[\@wall@calendarLanguage]{babel}
\fi

\RequirePackage{nag}
% Don't use [cmyk] option on xcolor. Declare text colors either in gray or cmyk (for color).
\RequirePackage{xcolor}
\RequirePackage{graphicx}
\DeclareGraphicsExtensions{.pdf,.png,.jpg}
\graphicspath{{\@wall@imageFolder}}

\RequirePackage{eso-pic}
\RequirePackage{ccicons}
\RequirePackage{multicol}
\RequirePackage{wasysym}

\RequirePackage{pdftexcmds}
\RequirePackage{etoolbox}
\RequirePackage{luacode}

\RequirePackage{xcoffins}
%\RequirePackage{xstring}
%\RequirePackage{stringstrings}

\ifloadBabel
\RequirePackage[final,babel=true]{microtype}
\else
\RequirePackage[final]{microtype}
\fi

\RequirePackage{tikz}
\usetikzlibrary{calendar}
\usetikzlibrary{positioning}
\usetikzlibrary{fit}
\usetikzlibrary{shapes.geometric}

% http://tex.stackexchange.com/a/20426/831
\pgfdeclarelayer{one}
\pgfdeclarelayer{two}
\pgfsetlayers{main,one,two}

\pgfkeys{%
  /tikz/on layer/.code={
    \pgfonlayer{#1}\begingroup
    \aftergroup\endpgfonlayer
    \aftergroup\endgroup
  }
}
\end{verbatim}

\section{Colors}
\label{sec:orgce34dfd}

\begin{verbatim}
\definecolor{textbody}{gray}{0.15}

% pantone 1245C, RGB 191,145,12 HEX: #BF910C
% pantone 1255C, CMYK 0,27.5,100,34
\definecolor{gold}{cmyk}{0,0.275,1,0.34}
\definecolor{darkgold}{cmyk}{0.27,0.53,1,0.09}
%\definecolor{orangegold}{cmyk}{0,0.31,0.89,0}
\colorlet{orangegold}{darkgold}

\colorlet{gridcolor}{black!30}
\colorlet{weekday}{black}
\colorlet{weekend}{black!50}
\colorlet{mooncolor}{textbody}

\definecolor{sunday}{RGB}{255,0,0}

\definecolor{datenum}{gray}{0.3}
\definecolor{plannerdatenum}{gray}{0.15}
\definecolor{quote}{gray}{0.3}
\definecolor{notes}{gray}{0.3}

\definecolor{gridcolor}{gray}{0.5}
\colorlet{pagebgcolor}{gridcolor!60}
\end{verbatim}

\texttt{showframe} option colors:

\begin{verbatim}
\colorlet{photo-frame}{blue}
\colorlet{quote-frame}{red}
\colorlet{heading-frame}{brown}
\colorlet{calendar-frame}{orange}
\colorlet{events-frame}{green}

\ifshowframe
  \colorlet{calendarbg}{black!50}
\else
  \colorlet{calendarbg}{white}
\fi
\end{verbatim}

\section{Page Size and Trim Marks}
\label{sec:org674f3ac}

\begin{verbatim}
\ifshowtrims
  \setstocksize{\calPaperHeight + \@wall@trimSpace}{\calPaperWidth + \@wall@trimSpace}
  \setlength{\paperheight}{\calPaperHeight}
  \setlength{\paperwidth}{\calPaperWidth}
  \trimXmarks
  \trimLmarks
  \quarkmarks
  \settrims{0.5\stockheight - 0.5\paperheight}{0.5\stockwidth - 0.5\paperwidth}
  \settrimmedsize{\calPaperHeight}{\calPaperWidth}{*}
\else\relax
  \setstocksize{\calPaperHeight}{\calPaperWidth}
  \settrims{0pt}{0pt}
  \settrimmedsize{\stockheight}{\stockwidth}{*}
\fi

%\settypeblocksize{\stockheight}{\stockwidth}{*}
% TODO: calculate margins by ratios to paper size
\setlrmarginsandblock{\@wall@leftMargin}{\@wall@rightMargin}{*}
\setulmarginsandblock{\@wall@topMargin}{\@wall@bottomMargin}{*}
\setheadfoot{0pt}{0pt}
\setheaderspaces{0pt}{*}{*}

\checkandfixthelayout% This will typeout values in pt.
\settypeoutlayoutunit{mm}% It is useful to see layout values in mm too.
\typeoutlayout

\setlength{\calTextWidth}{\calPaperWidth - \@wall@leftMargin - \@wall@rightMargin}
\setlength{\calTextHeight}{\calPaperHeight - \@wall@topMargin - \@wall@bottomMargin}
\end{verbatim}

\section{Base font sizes and indents}
\label{sec:org09f8d15}

\begin{verbatim}
\def\@wall@fontSize{11}
\def\@wall@lineHeight{13.6}

\renewcommand{\normalsize}{%
  \@setfontsize\normalsize\@wall@fontSize\@wall@lineHeight
  \abovedisplayskip 11\p@ \@plus3\p@ \@minus6\p@
  \abovedisplayshortskip \z@ \@plus3\p@
  \belowdisplayshortskip 6.5\p@ \@plus3.5\p@ \@minus3\p@
  \belowdisplayskip \abovedisplayskip
  \color{textbody}
  \let\@listi\@listI}
\normalsize

\setlength{\vgap}{1.5em}
\setlength{\vindent}{\vgap}
\setlength{\vleftmargin}{2em}

\setlength{\parskip}{0pt}
\setlength{\parindent}{0pt}

\setlength{\fboxsep}{0pt}
\end{verbatim}

\section{Helpers}
\label{sec:org846f73e}

\begin{verbatim}
#1 -- [fill=red, opacity=0.2], additional options used for showframe
#2 -- "hasvarnish", to indicate varnishmask color replacement when =varnishmask= option is used
#3 -- the content to hold the place for
\end{verbatim}


The \texttt{varnishmask} and \texttt{showframe} options are handled by the same \texttt{\textbackslash{}placeholder}
helper command to avoid having to use two commands and repeating the content
argument.

\begin{verbatim}
\definecolor{varnishmask}{gray}{0}

% http://tex.stackexchange.com/a/59571/831
\newcommand*{\strcmpblank}[3]{%
  \ifnum\pdf@strcmp{#1}{}=\z@ #2\else #3\fi
}

\newcommand\@placeholder@pre[1]{%
  \settowidth{\@tmp@width}{#1}%
  \settototalheight{\@tmp@height}{#1}%
  \def\@spacer{\rule{\@tmp@width}{0pt}\rule{0pt}{\@tmp@height}}%
}

\newcommand\placeholder[3][]{%
  \ifvarnishmask%
    \ifstrequal{#2}{hasvarnish}{%
      \@placeholder@pre{#3}%
      \tikz\node[fill=varnishmask, inner sep=0pt]{\@spacer};%
    }{}%
  \else%
    \ifshowframe%
      \@placeholder@pre{#3}%
      \tikz\node[inner sep=0pt, opacity=0.6, #1]{\@spacer};%
    \else%
      #3%
    \fi%
  \fi%
}

\newif\ifsixrowsmonth  
\sixrowsmonthfalse

\pgfkeys{/pgf/calendar/six rows month/.code={%
  \ifnum\pgfcalendarifdateday=30\relax
    % Monday
    \ifnum\pgfcalendarifdateweekday=0\relax
      \pgfcalendarmatchestrue
    \fi
  \else
    \ifnum\pgfcalendarifdateday=31\relax
      % Monday
      \ifnum\pgfcalendarifdateweekday=0\relax
	\pgfcalendarmatchestrue
      \fi
      % Tuesday
      \ifnum\pgfcalendarifdateweekday=1\relax
	\pgfcalendarmatchestrue
      \fi
    \fi
  \fi%
}}
\end{verbatim}

\chapter{Keys setup}
\label{sec:orgf165351}
\section{/put photo}
\label{sec:org898338f}

\begin{verbatim}
\def\@wall@photo@putPhoto#1{#1}
\def\@wall@photo@setYOffset{}

\pgfkeys{
  /put photo/.is family, /put photo,
  simple/.code = {%
    \def\@wall@photo@putPhoto##1{%
      \includegraphics{##1}%
    }%
    \def\@wall@photo@setYOffset{}%
  },
  full page/.code = {%
    \def\@wall@photo@putPhoto##1{%
      \includegraphics[%
	keepaspectratio,%
	width={\calPaperWidth + 2\@t@bleed},%
      ]{##1}%
    }%
    \def\@wall@photo@setYOffset{}%
  },
  full width above calendar/.code = {%
    \def\@wall@photo@putPhoto##1{%
      \includegraphics[%
	keepaspectratio,%
	width={\calPaperWidth + 2\@t@bleed},%
      ]{##1}%
    }%
    \def\@wall@photo@setYOffset{%
      \setlength{\@t@yOffset}{\@t@calendar@height + \@t@bleed + 1pt}%
    }%
  },
  full width/.code = {%
    \def\@wall@photo@putPhoto##1{%
      \includegraphics[%
	keepaspectratio,%
	width={\calPaperWidth + 2\@t@bleed},%
      ]{##1}%
    }%
    \def\@wall@photo@setYOffset{%
      \setlength{\@t@yOffset}{\@t@calendar@height + \@t@bleed}%
    }%
  },
  left/.code = {%
    \def\@wall@photo@putPhoto##1{%
      \begin{minipage}[t][\height][b]{\calPaperWidth + 6mm}%
	\raggedright

	\placeholder[fill=photo-frame]{hasvarnish}{%
	  \includegraphics[width=0.66\calPaperWidth + 3mm]{##1}%
	}%

	\vfill\mbox{}%
      \end{minipage}%
    }%
    \def\@wall@photo@setYOffset{}%
  },
  right/.code = {%
    \def\@wall@photo@putPhoto##1{%
      \begin{minipage}[t][\height][b]{\calPaperWidth + 6mm}%
	\raggedleft

	\placeholder[fill=photo-frame]{hasvarnish}{%
	  \includegraphics[width=0.66\calPaperWidth + 3mm]{##1}%
	}%

	\vfill\mbox{}%
      \end{minipage}%
    }%
    \def\@wall@photo@setYOffset{}%
  },
}
\end{verbatim}

\section{/put quote}
\label{sec:orgf4134a9}

\begin{verbatim}
\def\@wall@quote@putQuote#1{#1}

\pgfkeys{
  /put quote/.is family, /put quote,
  simple/.code = {%
    \def\@wall@quote@putQuote##1{%
      ##1%
    }%
  },
  left/.code = {%
    \def\@wall@quote@putQuote##1{%
      \begin{minipage}[b][0.5\calPaperHeight][t]{\calPaperWidth + 6mm}%
	\raggedright%
	\mbox{}\vfill%

	\hspace*{8mm}%
	\begin{minipage}{0.33\calPaperWidth - 10mm}%
	  \raggedleft%
	  \quoteFmt%
	  ##1%
	\end{minipage}%
      \end{minipage}%
    }%
  },
  right/.code = {%
    \def\@wall@quote@putQuote##1{%
      \begin{minipage}[b][0.5\calPaperHeight][t]{\calPaperWidth + 6mm}%
	\raggedleft%
	\mbox{}\vfill%

	\begin{minipage}{0.33\calPaperWidth - 10mm}%
	  \raggedright%
	  \quoteFmt%
	  ##1%
	\end{minipage}%
	\hspace*{8mm}%
      \end{minipage}%
    }%
  },
}
\end{verbatim}

\section{/Photo}
\label{sec:org7a9c88c}

\begin{verbatim}
\newif\ifPhotoEnabled
\PhotoEnabledtrue

\pgfkeys{
  /Photo/.is family, /Photo,
  init/.style = {
    defaults/.style = {disabled = false, file = {}, thumbFile = {}, caption = {}, bleed = 0pt, xOffset=0pt, yOffset=0pt},
    disabled/.initial = false,
    file/.initial = {},
    thumbFile/.initial = {},
    caption/.initial = {},
    bleed/.initial = 0pt,
    xOffset/.initial = 0pt,
    yOffset/.initial = 0pt,
  },
}
\end{verbatim}

\section{/Quote}
\label{sec:org8a930be}

\begin{verbatim}
\pgfkeys{
  /Quote/.is family, /Quote,
  init/.style = {
    defaults/.style = {position=center, text={}, xOffset=0pt, yOffset=0pt},
    position/.initial = {},
    text/.initial = {},
    xOffset/.initial = 0pt,
    yOffset/.initial = 0pt,
  },
}
\end{verbatim}

\section{/Calendar}
\label{sec:org2141145}

\begin{verbatim}
\pgfkeys{
  /Calendar/.is family, /Calendar,
  init/.style = {
    defaults/.style = {bg/.style={opacity=0.5}},
    bg/.style = {},
    minimum height/.initial = {},
  },
}
\end{verbatim}

\section{/Events}
\label{sec:org3ce3978}

\begin{verbatim}
\pgfkeys{
  /Events/.is family, /Events,
  init/.style = {
    defaults/.style = {day code = {}, marks = {}, text = {}},
    day code/.initial = {},
    marks/.initial = {},
    text/.initial = {},
  },
}
\end{verbatim}

\section{/Txt}
\label{sec:org8bf987b}

\begin{verbatim}
\pgfkeys{
  /Txt/.is family, /Txt,
  init/.style = {
    defaults/.style = {text = {}},
    text/.initial = {},
  },
}
\end{verbatim}

\section{/parseMonthEvents}
\label{sec:orgb0d314b}

\begin{verbatim}
\def\eIdx{}
\def\eMaxIdx{}
\def\eMark{}
\def\eIsoDate{}
\def\eYear{}
\def\eMonth{}
\def\eMonthShort{}
\def\eDay{}
\def\eDayText{}
\def\eNote{}

\pgfkeys{
  /parseMonthEvents/.is family, /parseMonthEvents,
  month/.initial = {},
  filter pred/.initial = nil,
  format func/.initial = nil,
  format cmd/.initial = {},
  events csv/.initial = {},
  mark defaults csv/.initial = {},
  min events/.initial = {},
  defaults/.style = {
    month = \theMonthName,
    filter pred = nil,
    format func = nil,
    format cmd = {\textsuperscript{\eIdx}~\eMonthShort~\eDay:~\eNote\par},
    events csv = \@wall@eventsCsv,
    mark defaults csv = \@wall@markDefaultsCsv,
    min events = nil,
  },
}
\end{verbatim}

\section{/parseYearEvents}
\label{sec:org966a94d}

\begin{verbatim}
\pgfkeys{
  /parseYearEvents/.is family, /parseYearEvents,
  year/.initial = {},
  filter pred/.initial = nil,
  format func/.initial = nil,
  format cmd/.initial = {},
  events csv/.initial = {},
  mark defaults csv/.initial = {},
  min events/.initial = {},
  defaults/.style = {
    year = \CalendarYear,
    filter pred = nil,
    format func = nil,
    format cmd = {\textsuperscript{\eIdx}~\eMonthShort~\eDay:~\eNote\ifnumless{\eIdx}{\eMaxIdx}{,\space}{.}},
    events csv = \@wall@eventsCsv,
    mark defaults csv = \@wall@markDefaultsCsv,
    min events = nil,
  },
}
\end{verbatim}

\chapter{Event Marks}
\label{sec:org8a583ff}
\section{Kite}
\label{sec:org126ee45}

\begin{verbatim}
\newcommand\StarMark{*}

\newcommand\NoteStarMark{*}
\end{verbatim}

A kite mark that is the same height as the \texttt{\textbackslash{}StarMark}. Note that the star (*)
character is usually higher than the x-height, so it is not in the vertical
center of its glyph box (i.e. not at the center of the character x):

\frame{x} \frame{*}

\begin{verbatim}
\newlength\@wall@starHeight

% Measure the star's height here, so that we are measuring with the current typeface.
\newcommand\KiteMark{%
\setlength{\@wall@starHeight}{\totalheightof{*}}%
\begin{tikzpicture}
  \node (box) [
    rectangle, minimum height=\@wall@starHeight, minimum width=3.4pt,
    inner sep=0pt, line width=0pt,
  ] {};
  \node[
    kite, draw, textbody, fill=textbody,
    scale=0.15, kite vertex angles=60,
    above=0pt of box.north, anchor=north,
  ] {};%
\end{tikzpicture}%
}

% Same as \KiteMark but with scale=0.2
\newcommand\NoteKiteMark{\raisebox{1pt}{%
\setlength{\@wall@starHeight}{\totalheightof{*}}%
\begin{tikzpicture}
  \node (box) [
    rectangle, minimum height=\@wall@starHeight, minimum width=3.4pt,
    inner sep=0pt, line width=0pt,
  ] {};
  \node[
    kite, draw, textbody, fill=textbody,
    scale=0.2, kite vertex angles=60,
    above=0pt of box.north, anchor=north,
  ] {};%
\end{tikzpicture}%
}}
\end{verbatim}

\section{Moons}
\label{sec:org6fefa39}

\begin{verbatim}
\tikzstyle{moon circle}=[
  circle,
  inner sep=0pt,
  line width=0pt,
  minimum height=8pt,
]

\newlength\@wall@moonRaise
\setlength{\@wall@moonRaise}{-0.7pt}

\newcommand\NewMoon{}
\newcommand\FirstQuarter{}
\newcommand\FullMoon{}
\newcommand\LastQuarter{}

\newcommand\@wall@NewMoon{%
\raisebox{\@wall@moonRaise}{%
  \tikz\node[moon circle, fill=mooncolor] {};%
}}

\newcommand\@wall@FullMoon{%
\raisebox{\@wall@moonRaise}{%
  \tikz\node[moon circle, draw, mooncolor, line width=0.3pt] {};%
}}

\newcommand\@wall@FirstQuarter{%
\raisebox{\@wall@moonRaise}{%
\begin{tikzpicture}
\node [moon circle, name=waxing] {};
\path[fill=mooncolor]
  (waxing.north) --
  (waxing.south) to[out=-180,in=-90]
  (waxing.west) to[out=90,in=-180]
  (waxing.north);
\end{tikzpicture}%
}}

\newcommand\@wall@LastQuarter{%
\raisebox{\@wall@moonRaise}{%
\begin{tikzpicture}
\node [moon circle, name=waning] {};
\path[fill=mooncolor]
  (waning.north) --
  (waning.south) to[out=0,in=-90]
  (waning.east) to[out=90,in=0]
  (waning.north);
\end{tikzpicture}%
}}

\newcommand\@wall@useDefaultMoons{%
\renewcommand\NewMoon{\@wall@NewMoon}%
\renewcommand\FirstQuarter{\@wall@FirstQuarter}%
\renewcommand\FullMoon{\@wall@FullMoon}%
\renewcommand\LastQuarter{\@wall@LastQuarter}%
}

\newcommand\plannerMoonSize{\@setfontsize\plannerMoonSize{14}{14}}
\newcommand*\plannerMoonFormat[1]{{\plannerMoonSize #1}}

\newcommand\@wall@planner@NewMoon{\plannerMoonFormat{\CIRCLE}}
\newcommand\@wall@planner@FirstQuarter{\plannerMoonFormat{\LEFTcircle}}
\newcommand\@wall@planner@FullMoon{\plannerMoonFormat{\Circle}}
\newcommand\@wall@planner@LastQuarter{\plannerMoonFormat{\RIGHTcircle}}

\newcommand\@wall@usePlannerMoons{%
\renewcommand\NewMoon{\@wall@planner@NewMoon}%
\renewcommand\FirstQuarter{\@wall@planner@FirstQuarter}%
\renewcommand\FullMoon{\@wall@planner@FullMoon}%
\renewcommand\LastQuarter{\@wall@planner@LastQuarter}%
}

\@wall@useDefaultMoons
\end{verbatim}

\chapter{User Commands}
\label{sec:org5ceabf3}
\section{\textbackslash SetPhoto}
\label{sec:org769e373}

\begin{verbatim}
\SetPhoto[bleed=3mm]{June}
\end{verbatim}


\begin{verbatim}
\newcommand\SetPhoto[2][]{%
  \pgfkeys{%
    /Photo/#2/.is family, /Photo/#2,
    /Photo/init,
    defaults, file={#2},
    #1%
  }%
}
\end{verbatim}

\section{\textbackslash SetCalendar}
\label{sec:org8a21952}

\begin{verbatim}
\SetCalendar[bg={opacity=0.8}]{June}
\end{verbatim}


\begin{verbatim}
\newcommand\SetCalendar[2][]{%
  \pgfkeys{%
    /Calendar/#2/.is family, /Calendar/#2,
    /Calendar/init,
    defaults,
    #1%
  }%
}
\end{verbatim}

\section{\textbackslash SetQuote}
\label{sec:org7a27978}

\begin{verbatim}
\SetQuote[position=top right, text align=right]{June}{%
first line\\
second line\\
third line\\
fourth line
}
\end{verbatim}


\begin{verbatim}
\newcommand\SetQuote[3][]{%
  \pgfkeys{%
    /Quote/#2/.is family, /Quote/#2,
    /Quote/init,
    defaults, text={#3},
    #1%
  }%
}
\end{verbatim}

\section{\textbackslash SetEvents}
\label{sec:org73f2042}

FIXME: Needs at least a \texttt{\textbackslash{}SetEvents\{\#2\}} to set defaults.

\begin{verbatim}
\SetEvents[yshift={10pt}]{August}{%
marks
}{%
text
}
\end{verbatim}


\begin{verbatim}
#1 : options
#2 : month name
#3 : marks
#4 : text
\end{verbatim}


\begin{verbatim}
\newcommand\SetEvents[4][]{%
  \pgfkeys{%
    /Events/#2/.is family, /Events/#2,
    /Events/init,
    defaults, marks={#3}, text={#4},
    #1%
  }%
}
\end{verbatim}

\section{\textbackslash MonthPage}
\label{sec:org6f244a2}

The \texttt{/MonthPage} key is set in-place for each page, not collecting options per month.

\begin{verbatim}
\pgfkeys{
  /MonthPage/.is family, /MonthPage,
  layout/.style = {layout handlers/#1/.get = \@wall@month@doLayout},
  put photo/.style = {/put photo/#1},
  put quote/.style = {/put quote/#1},
  defaults/.style = {layout = small landscape, put photo = simple, put quote = simple},
  layout handlers/.cd,
    full page/.initial = \@wall@fullPageLayout,
    small landscape/.initial = \@wall@smallLandscapeLayout,
    photo and notes/.initial = \@wall@photoAndNotesLayout,
    large calendar/.initial = \@wall@largeCalendarLayout,
}
\end{verbatim}

FIXME: handle case when no \texttt{\textbackslash{}SetPhoto\{\#2\}} was called, and so options are not
initialized. This happens for example when bleed value is missing, and \texttt{.get}
returns \texttt{\textbackslash{}@val}:

\begin{verbatim}
! Missing number, treated as zero.
<to be read again> 
\@val 
l.30 \MonthPage[layout=full page]{August}
\end{verbatim}


For now, just make sure there is a \texttt{\textbackslash{}SetPhoto\{August\}} before \texttt{\textbackslash{}MonthPage\{August\}}.

\begin{verbatim}
\MonthPage[layout=full page]{June}
\end{verbatim}


\begin{verbatim}
\newcommand\MonthPage[2][]{%
  \pgfkeys{/MonthPage, defaults, #1}%
  \@wall@month@doLayout{#2}%
}
\end{verbatim}

\section{\textbackslash SetTxt}
\label{sec:org79e062d}

\begin{verbatim}
\SetTxt{August Quote}{%
The text of the quote.
}
\end{verbatim}


\begin{verbatim}
#1 : key
#2 : text
\end{verbatim}


\begin{verbatim}
\newcommand\SetTxt[2]{%
  \pgfkeys{%
    /Txt/#1/.is family, /Txt/#1,
    /Txt/init,
    defaults, text={#2},
  }%
}
\end{verbatim}

\section{\textbackslash txt}
\label{sec:orgc34fee8}

\begin{verbatim}
\txt{August Quote}
\end{verbatim}


\begin{verbatim}
#1: text key
\end{verbatim}


\begin{verbatim}
\newcommand\txt[1]{%
\pgfkeys{/Txt/#1/text/.get=\@val}%
\@val%
}
\end{verbatim}

\section{\textbackslash parseMonthEvents}
\label{sec:org8268055}

\begin{verbatim}
\def\@t@monthName{}
\def\@t@eventsCsv{}
\def\@t@markDefaultsCsv{}
\def\@t@filterPred{}
\def\@t@formatFunc{}
\def\@t@formatCmd{}
\def\@t@minEvents{}

\newcommand\monthMarkFmt{\color{textbody}}

\newcommand\symbolSpace{\thinspace}
\newcommand\symbolSeparator{,\symbolSpace}

% Semicolon to close the tikz calendar. Necessary before starting to use \node
% or \draw commands.
\newcommand\semicolonEndTikzCalendar{%
  ;%
}

% #1 = option keys
\newcommand*\parseMonthEvents[1][]{%
\pgfkeys{/parseMonthEvents, defaults, #1,
  month/.get=\@t@monthName,
  filter pred/.get=\@t@filterPred,
  format func/.get=\@t@formatFunc,
  format cmd/.get=\@t@formatCmd,
  events csv/.get=\@t@eventsCsv,
  mark defaults csv/.get=\@t@markDefaultsCsv,
  min events/.get=\@t@minEvents,
}%
\luadirect{
require("wallcalendar-helpers.lua")
monthEvents(
  \luastring{\@t@monthName},
  \@t@filterPred,
  \@t@formatFunc,
  \luastringO{\@t@formatCmd},
  \luastring{\@t@eventsCsv},
  \luastring{\@t@markDefaultsCsv},
  \@t@minEvents
)}}
\end{verbatim}

\section{\textbackslash parseYearEvents}
\label{sec:orgbee8a4f}

\begin{verbatim}
\def\@t@yearNum{}

% #1 = option keys
\newcommand*\parseYearEvents[1][]{%
\pgfkeys{/parseYearEvents, defaults, #1,
  year/.get=\@t@year,
  filter pred/.get=\@t@filterPred,
  format func/.get=\@t@formatFunc,
  format cmd/.get=\@t@formatCmd,
  events csv/.get=\@t@eventsCsv,
  mark defaults csv/.get=\@t@markDefaultsCsv,
  min events/.get=\@t@minEvents,
}%
\luadirect{
require("wallcalendar-helpers.lua")
yearEvents(
  tonumber(\@t@year),
  \@t@filterPred,
  \@t@formatFunc,
  \luastringO{\@t@formatCmd},
  \luastring{\@t@eventsCsv},
  \luastring{\@t@markDefaultsCsv},
  \@t@minEvents
)}}
\end{verbatim}

\section{\textbackslash parseMonthMarksDayText}
\label{sec:org5faa64b}

NOTE: Tikz will not work with parsing options as with \texttt{\textbackslash{}parseMonthEvents}.

It will parse the CSV file set with the \texttt{eventsCsv} class option.

\begin{verbatim}
\newlength\dayTextXshift
\newlength\dayTextYshift
\setlength{\dayTextXshift}{0pt}
\setlength{\dayTextYshift}{0pt}

\newlength\markNumberAbove
\newlength\markNumberRight
\setlength{\markNumberAbove}{-10pt}
\setlength{\markNumberRight}{-3pt}

\newlength\markDayTextAbove
\newlength\markDayTextRight
\setlength{\markDayTextAbove}{-10pt}
\setlength{\markDayTextRight}{-3pt}

\newcommand\parseMonthMarksDayText{%
\luadirect{
require("wallcalendar-helpers.lua")
monthMarksDayText(\luastring{\theMonthName}, nil, \luastring{\@wall@eventsCsv})
tex.sprint(';')
}}

\newcommand\parseMonthMarksDayTextMonth[1]{%
\luadirect{
require("wallcalendar-helpers.lua")
monthMarksDayText(\luastring{#1}, nil, \luastring{\@wall@eventsCsv})
tex.sprint(';')
}}
\end{verbatim}

\section{\textbackslash parseMonthMarksDayTextUsing}
\label{sec:org589ec47}

\begin{verbatim}
\newcommand*\parseMonthMarksDayTextUsing[1]{%
\luadirect{
require("wallcalendar-helpers.lua")
monthMarksDayText(\luastring{\theMonthName}, nil, \luastring{#1})
}}

\newcommand\parseMonthMarksDayTextMonthUsing[2]{%
\luadirect{
require("wallcalendar-helpers.lua")
monthMarksDayText(\luastring{#1}, nil, \luastring{#2})
}}
\end{verbatim}

\section{\textbackslash parseMonthMarksDayTextInlineUsing}
\label{sec:org34ae740}

\begin{verbatim}
\newcommand*\parseMonthMarksDayTextInlineUsing[1]{%
\luadirect{
require("wallcalendar-helpers.lua")
monthMarksDayTextInline(\luastring{\theMonthName}, nil, \luastring{#1})
}}
\end{verbatim}

\section{\textbackslash parseMonthMarksNote}
\label{sec:org210d0ef}

\begin{verbatim}
\newcommand*\parseMonthMarksNote{%
\luadirect{
require("wallcalendar-helpers.lua")
monthMarksNote(\luastring{\theMonthName}, nil, \luastring{\@wall@eventsCsv}, \luastring{\@wall@markDefaultsCsv})
}}
\end{verbatim}

\section{\textbackslash parseMonthMarksNoteUsing}
\label{sec:org580bac4}

\begin{verbatim}
\newcommand*\parseMonthMarksNoteUsing[1]{%
\luadirect{
require("wallcalendar-helpers.lua")
monthMarksNote(\luastring{\theMonthName}, nil, \luastring{#1}, \luastring{\@wall@markDefaultsCsv})
}}
\end{verbatim}

\section{\textbackslash parseMonthInlineNotes}
\label{sec:org75bcbbe}

\begin{verbatim}
\newcommand*\parseMonthInlineNotes{%
\luadirect{
require("wallcalendar-helpers.lua")
monthInlineNotes(\luastring{\theMonthName}, nil, \luastring{\@wall@eventsCsv}, \luastring{\@wall@markDefaultsCsv})
}}
\end{verbatim}

\chapter{Page Layouts}
\label{sec:orga19b720}
\section{Initial setup}
\label{sec:orga88ba1c}

Applying a blank, bare pagestyle, the layout macro should position the parts of
the page.

\begin{verbatim}
\makepagestyle{month}
\makeoddhead{month}{}{}{}
\makeevenhead{month}{}{}{}
\makeoddfoot{month}{}{}{}
\makeevenfoot{month}{}{}{}

\pagestyle{month}
\end{verbatim}

These elements are common to all layouts. One Coffin for each part of the
page:

\begin{itemize}
\item Photo
\item Quote
\item Calendar
\item Events
\end{itemize}

\begin{verbatim}
\NewCoffin\@wall@pageWrap
\NewCoffin\@wall@photo
\NewCoffin\@wall@quote
\NewCoffin\@wall@calendar
\NewCoffin\@wall@events
\NewCoffin\@wall@notepad
\NewCoffin\@wall@photoPageWrap
\NewCoffin\@wall@notesPageWrap
\end{verbatim}

\section{Formatting hooks and temp vars}
\label{sec:orgfcb649d}

\begin{verbatim}
\newlength\@t@bleed
\newlength\@t@rightOffset
\newlength\@t@minipageWidth
\newlength\@t@calendar@minimumHeight
\newlength\@t@calendar@height
\newlength\@t@calendar@hmargin
\newlength\@t@calendar@verticalSpacing
\newlength\@t@calendar@dayYshift
\newlength\@t@calendar@dayXshift
\newlength\@t@calendar@gridHeight
\newlength\@t@calendar@gridHeightFiveRows
\newlength\@t@calendar@gridHeightSixRows
\newlength\@t@xOffset
\newlength\@t@yOffset
\def\@t@file{}

\newcommand*\monthFmt{}%
\newcommand*\yearFmt{}%
\newcommand*\dayLetterColor{}%
\newcommand*\dayLetterFmt{}%
\newcommand*\dayTextFmt{}%
\newcommand*\quoteFmt{}%
\newcommand*\headingFmt{}%
\newcommand*\calendarFmt{}%
\newcommand*\eventsFmt{}%
\newcommand*\dayLetterTextFmt[1]{#1}
\end{verbatim}

\section{Layout Reset, \textbackslash @wall@layout@reset}
\label{sec:org4178b0e}

A reset macro for the beginning of a layout, to make sure parameters are not
carried from one layout to the next.

\begin{verbatim}
\newcommand\@wall@layout@reset{%
  \renewcommand*\monthFmt{}%
  \renewcommand*\yearFmt{}%
  \renewcommand*\dayLetterColor{}%
  \renewcommand*\dayLetterFmt{}%
  \renewcommand*\dayTextFmt{}%
  \renewcommand*\quoteFmt{}%
  \renewcommand*\headingFmt{}%
  \renewcommand*\calendarFmt{}%
  \renewcommand*\eventsFmt{}%
  \def\@t@file{}%
  \setlength{\@t@calendar@height}{0pt}%
  \setlength{\@t@calendar@hmargin}{0pt}%
  \setlength{\@t@calendar@dayYshift}{0pt}%
  \setlength{\@t@calendar@dayXshift}{0pt}%
  \setlength{\@t@bleed}{0pt}%
  \setlength{\@t@rightOffset}{0pt}%
  \setlength{\@t@minipageWidth}{0pt}%
  \setlength{\@t@xOffset}{0pt}%
  \setlength{\@t@yOffset}{0pt}%
  \setlength{\@t@calendar@gridHeight}{0pt}%
  \setlength{\@t@calendar@gridHeightFiveRows}{0pt}%
  \setlength{\@t@calendar@gridHeightSixRows}{0pt}%
}
\end{verbatim}

\section{Full Page, \textbackslash @wall@fullPageLayout}
\label{sec:orgc8c056f}
\subsection{Setup formatting hooks}
\label{sec:org00eec7b}

Renew this in your document when customizing the variables for this layout.

This must not introduce paragraph breaks or whitespace characters, so follow
everything with \texttt{\%}.

\begin{verbatim}
\newcommand\fullPageFmt{%
  \renewcommand*\monthFmt{\LARGE}%
  \renewcommand*\yearFmt{\LARGE}%
  \renewcommand*\dayLetterColor{}%
  \renewcommand*\dayLetterFmt{\tiny}%
  \renewcommand*\dayTextFmt{\small}%
  \renewcommand*\quoteFmt{}%
  \renewcommand*\headingFmt{\centering}%
  \renewcommand*\calendarFmt{\centering}%
  \renewcommand*\eventsFmt{\setlength{\parindent}{0pt}\raggedleft\footnotesize}%
}
\end{verbatim}

\subsection{Init}
\label{sec:org8f3ec94}

\begin{verbatim}
\newcommand\@wall@fullPageLayout[2][]{%
\makeatletter
\renewcommand*\theMonthName{#2}
\@wall@layout@reset
\fullPageFmt

\colorlet{weekday}{black}
\colorlet{weekend}{black!70}
\end{verbatim}

\subsection{Lengths and sizes}
\label{sec:org14e3366}

Bleed:

\begin{verbatim}
\pgfkeys{/Photo/#2/bleed/.get=\@val}
\setlength{\@t@bleed}{\@val}
\end{verbatim}

\begin{verbatim}
\def\@t@monthnum{\monthToNum{#2}}
\end{verbatim}

Calendar height:

\begin{verbatim}
% 40mm = 1.5748 inch
% 43mm = 1.6929 inch
\setlength{\@t@calendar@height}{40mm + \@t@bleed}

% See if there was a height given in the options
\pgfkeys{/Calendar/#2/minimum height/.get=\@val}
\ifx\@val\empty \relax
\else
  \setlength{\@t@calendar@height}{\@val + \@t@bleed}
\fi
\end{verbatim}

Calendar horizontal margin:

\begin{verbatim}
\setlength{\@t@calendar@hmargin}{20pt}
\end{verbatim}

Calculate offsets:

\begin{verbatim}
% NOTE: the -4pt and -2pt offset is somehow necessary for the sides to align
% with the edges
\setlength{\@t@rightOffset}{\@t@bleed +\@t@calendar@hmargin -4pt}
\setlength{\@t@minipageWidth}{\calPaperWidth -2\@t@calendar@hmargin -2pt}
\end{verbatim}

\subsection{Set the coffin contents}
\label{sec:orgd76e8bd}

Page wrap:

\begin{verbatim}
\SetHorizontalCoffin\@wall@pageWrap{%
  \color{white}%
  \rule{\textwidth}{0pt}%
  \rule{0pt}{\textheight}%
}
\end{verbatim}

Photo:

\begin{verbatim}
\pgfkeys{/Photo/#2/file/.get=\@t@file}

\SetHorizontalCoffin\@wall@photo{%
  \placeholder[fill=photo-frame]{hasvarnish}{%
    \@wall@photo@putPhoto{\@t@file}%
  }%
}
\end{verbatim}

Quote:

\begin{verbatim}
\SetHorizontalCoffin\@wall@quote{%
  \placeholder[fill=quote-frame]{}{%
    \begin{minipage}{\linewidth}%
      \quoteFmt
      \pgfkeys{/Quote/#2/text/.get=\@val}%
      \@val%
    \end{minipage}%
  }%
}
\end{verbatim}

Calendar:

\begin{verbatim}
\SetHorizontalCoffin\@wall@calendar{%
\ifvarnishmask\relax
\else
\begin{tikzpicture}

\node (bg) [
  fill = calendarbg,
  opacity = 0.5,
  minimum width = {\calPaperWidth + 2\@t@bleed},
  anchor=north west,
  /Calendar/#2/bg,
  % override the style, in case bleed was set above
  minimum height = {\@t@calendar@height},
] at (0,0) {};

\node (heading) [
  below right=10pt and {\@t@rightOffset} of bg.north west,
  anchor=north west,
] {%
\placeholder[fill=heading-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\headingFmt
{\monthFmt\@tr@monthNumName{\@t@monthnum}}
\hfill
\strcmpblank{\CalendarAltYear}{%
   {\yearFmt\CalendarYear}%
}{%
  {\yearFmt\CalendarYear/\CalendarAltYear}%
}%
\end{minipage}%
}%
};

\node (calendar) [
  below right=35pt and {\@t@rightOffset} of bg.north west,
  anchor=north west,
] {%
\placeholder[fill=calendar-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\calendarFmt
\tikz{\tikzMonthCalendar@fullpage{\@t@monthnum};}%
\end{minipage}%
}%
};

\node (events) [
  below=0pt of calendar.south west,
  anchor=north west,
] {%
\placeholder[fill=events-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\eventsFmt
\pgfkeys{/Events/#2/text/.get=\@val}%
\@val%
\end{minipage}%
}%
};

\end{tikzpicture}%
\fi
}% \SetHorizontalCoffin
\end{verbatim}

\subsection{Join the coffins}
\label{sec:org5055715}

\begin{verbatim}
\@wall@photo@setYOffset

\pgfkeys{/Photo/#2/xOffset/.get=\@val}
\addtolength{\@t@xOffset}{\@val}
\pgfkeys{/Photo/#2/yOffset/.get=\@val}
\addtolength{\@t@yOffset}{\@val}

% NOTE: a small whitespace is visible on the left edge of the page when bleed is 0pt, a space must be getting in somewhere.
\JoinCoffins*\@wall@pageWrap[l,t]\@wall@photo[l,t](-\spinemargin -\@t@bleed + \@t@xOffset, \uppermargin + \@t@bleed + \@t@yOffset)

\pgfkeys{/Quote/#2/xOffset/.get=\@val}
\setlength{\@t@xOffset}{\@val}
\pgfkeys{/Quote/#2/yOffset/.get=\@val}
\setlength{\@t@yOffset}{\@val}

\JoinCoffins*\@wall@pageWrap[l,t]\@wall@quote[l,t](\@t@xOffset, \@t@yOffset)

\JoinCoffins*\@wall@pageWrap[l,b]\@wall@calendar[l,b](-\spinemargin -\@t@bleed, \textheight +\uppermargin -\paperheight -\@t@bleed)

\makeatother
\end{verbatim}

\subsection{Typeset}
\label{sec:orgafe47ba}

\begin{verbatim}
\clearpage
\TypesetCoffin\@wall@pageWrap%
}% \@wall@fullPageLayout
\end{verbatim}

\subsection{Tikz calendar}
\label{sec:org9549fc0}

\begin{verbatim}
#1 = number of month with leading zero
\end{verbatim}


\begin{verbatim}
\newcommand*{\tikzMonthCalendar@fullpage}[1]{%
\pgfkeys{/Events/\monthName{#1}/marks/.get=\@eventmarks}%
\calendar (cal#1) [alnitak, dates=\CalendarYear-#1-01 to \CalendarYear-#1-last] \@eventmarks;%
}
\end{verbatim}

\section{Small Landscape, \textbackslash @wall@smallLandscapeLayout}
\label{sec:orgdbef81d}
\subsection{Setup formatting hooks}
\label{sec:org4827364}

Renew this in your document when customizing the variables for this layout.

This must not introduce paragraph breaks or whitespace characters, so follow
everything with \texttt{\%}.

\begin{verbatim}
\newcommand\smallLandscapeFmt{%
  \renewcommand*\monthFmt{\LARGE}%
  \renewcommand*\yearFmt{\LARGE}%
  \renewcommand*\dayLetterColor{}%
  \renewcommand*\dayLetterFmt{\tiny}%
  \renewcommand*\dayTextFmt{\small}%
  \renewcommand*\quoteFmt{\centering}%
  \renewcommand*\headingFmt{\centering}%
  \renewcommand*\calendarFmt{\centering}%
  \renewcommand*\eventsFmt{\setlength{\parindent}{0pt}\raggedright\footnotesize}%
  \setlength{\@t@calendar@minimumHeight}{85mm}%
  \setlength{\@t@calendar@hmargin}{20pt}%
  % 5mm: day headings
  % 20mm: events
  % 6.5mm: white space
  \setlength{\@t@calendar@verticalSpacing}{20mm + 5mm + 6.5mm}%
}
\end{verbatim}

\subsection{Init}
\label{sec:orgea0808e}

\begin{verbatim}
\newcommand\@wall@smallLandscapeLayout[2][]{%
\makeatletter
\renewcommand*\theMonthName{#2}
\@wall@layout@reset
\smallLandscapeFmt

\colorlet{weekday}{black}
\colorlet{weekend}{black!70}
\end{verbatim}

\subsection{Lengths and sizes}
\label{sec:orgaa81909}

Bleed:

\begin{verbatim}
\pgfkeys{/Photo/#2/bleed/.get=\@val}
\setlength{\@t@bleed}{\@val}
\end{verbatim}

\begin{verbatim}
\def\@t@monthnum{\monthToNum{#2}}
\end{verbatim}

Calendar height:

Default height to fit:

\begin{itemize}
\item day headings
\item days in a grid, 6 rows
\item events
\item bottom bleed
\end{itemize}

\begin{verbatim}
\setlength{\@t@calendar@height}{\@t@calendar@minimumHeight + \@t@bleed}

% See if there was a height given in the options
\pgfkeys{/Calendar/#2/minimum height/.get=\@val}
\ifx\@val\empty \relax
\else
  \setlength{\@t@calendar@height}{\@val + \@t@bleed}
\fi
\end{verbatim}

Calculate offsets:

\begin{verbatim}
\setlength{\@tmp@a}{\@t@calendar@verticalSpacing}
\setlength{\@tmp@b}{\@t@calendar@height -\@tmp@a}
\setlength{\@t@calendar@dayYshift}{0.1666\@tmp@b}% 1/6 = 0.1666

\setlength{\@t@calendar@gridHeightSixRows}{\@tmp@b}
\setlength{\@t@calendar@gridHeightFiveRows}{\@tmp@b -0.1666\@tmp@b}

% NOTE: the -4pt and -2pt offset is somehow necessary for the sides to align
% with the edges
\setlength{\@t@rightOffset}{\@t@bleed +\@t@calendar@hmargin -4pt}
\setlength{\@t@minipageWidth}{\calPaperWidth -2\@t@calendar@hmargin -2pt}

\setlength{\@t@calendar@dayXshift}{0.1428\@t@minipageWidth}% 1/7 = 0.1428
\end{verbatim}

\subsection{Set the coffin contents}
\label{sec:org83e829f}

Page wrap:

\begin{verbatim}
\SetHorizontalCoffin\@wall@pageWrap{%
  \color{white}%
  \rule{\textwidth}{0pt}%
  \rule{0pt}{\textheight}%
}
\end{verbatim}

Photo:

\begin{verbatim}
\pgfkeys{/Photo/#2/file/.get=\@t@file}

\SetHorizontalCoffin\@wall@photo{%
  \placeholder[fill=photo-frame]{hasvarnish}{%
    \@wall@photo@putPhoto{\@t@file}%
  }%
}
\end{verbatim}

Quote:

\begin{verbatim}
\SetHorizontalCoffin\@wall@quote{%
  \placeholder[fill=quote-frame]{}{%
    \begin{minipage}{\linewidth}%
      \quoteFmt
      \pgfkeys{/Quote/#2/text/.get=\@val}%
      \@val%
    \end{minipage}%
  }%
}
\end{verbatim}

Calendar:

\begin{verbatim}
\SetHorizontalCoffin\@wall@calendar{%
\ifvarnishmask\relax
\else
\begin{tikzpicture}

\node (bg) [
  fill = calendarbg,
  opacity = 1,
  minimum width = {\calPaperWidth + 2\@t@bleed},
  anchor=north west,
  /Calendar/#2/bg,
  % override the style, in case bleed was set above
  minimum height = {\@t@calendar@height},
] at (0,0) {};

\node (heading) [
  below right=10pt and {\@t@rightOffset} of bg.north west,
  anchor=north west,
] {%
\placeholder[fill=heading-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\headingFmt
{\monthFmt\@tr@monthNumName{\@t@monthnum}}
\hfill
\strcmpblank{\CalendarAltYear}{%
   {\yearFmt\CalendarYear}%
}{%
  {\yearFmt\CalendarYear/\CalendarAltYear}%
}%
\end{minipage}%
}%
};

\node (calendar) [
  below right=35pt and {\@t@rightOffset} of bg.north west,
  anchor=north west,
] {%
\placeholder[fill=calendar-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\calendarFmt
\hspace*{-5pt}% FIXME
\tikz{\tikzMonthCalendar@smallLandscape{\@t@monthnum};}%
\end{minipage}%
}%
};

\node (events) [
  above right=10mm and {\@t@rightOffset} of bg.south west,
  anchor=south west,
] {%
\placeholder[fill=events-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\eventsFmt
\pgfkeys{/Events/#2/text/.get=\@val}%
\@val%
\end{minipage}%
}%
};

\end{tikzpicture}%
\fi
}% \SetHorizontalCoffin
\end{verbatim}

\subsection{Join the coffins}
\label{sec:orga14d3db}

Only using \texttt{yOffset}. The quote should be centered on the x axis.

Join coffins so that the photo is in a fixed position, i.e. relative to the
pageWrap, not relative to other coffins. It prevents accidental shifts when the
other coffins are empty (when \texttt{varnishmask} is on) or have too much content.

\begin{verbatim}
% The quote has to be centered between the photo and the calendar with manual tweaking.
% The height of the quote is not known, the height of the calendar plus its heading is not known.

% TODO move the photo with /Photo/#2/xOffset and yOffset as at the full page layout

\pgfkeys{/Quote/#2/yOffset/.get=\@val}
\setlength{\@t@yOffset}{\@val}

\JoinCoffins*\@wall@photo[hc,b]\@wall@quote[hc,t](0pt, \@t@yOffset)

\pgfkeys{/Photo/#2/yOffset/.get=\@val}
\setlength{\@t@yOffset}{\@val}

% NOTE: Taking the bottom edge of the photo as fixed.
% yOffset must be set to pull the photo down into position

\JoinCoffins*\@wall@pageWrap[hc,t]\@wall@photo[hc,b](0pt, \uppermargin + \@t@yOffset)

% Calendar is aligned to the bottom of the page.

\JoinCoffins*\@wall@pageWrap[hc,b]\@wall@calendar[hc,b](0pt, \textheight +\uppermargin -\paperheight -\@t@bleed)

\makeatother
\end{verbatim}

\subsection{Typeset}
\label{sec:org98357bb}

\begin{verbatim}
\clearpage
\TypesetCoffin\@wall@pageWrap%
}% \@wall@smallLandscapeLayout
\end{verbatim}

\subsection{Tikz calendar}
\label{sec:orga334fd7}

\begin{verbatim}
#1 = number of month with leading zero
\end{verbatim}


\begin{verbatim}
\newcommand*{\tikzMonthCalendar@smallLandscape}[1]{%
\pgfkeys{/Events/\monthName{#1}/marks/.get=\@eventmarks}%
\calendar (cal#1) [betelgeuse, dates=\CalendarYear-#1-01 to \CalendarYear-#1-last] \@eventmarks;%
}
\end{verbatim}

\section{Photo And Notes, \textbackslash @wall@photoAndNotesLayout}
\label{sec:org6734396}
\subsection{Setup formatting hooks}
\label{sec:orgef61b00}

\begin{verbatim}
\newcommand\notepadContent{%
  \begin{minipage}{\@t@minipageWidth}%
    \setlength\parindent{0pt}%
    \setlength\parskip{10pt}%
    \color{black!40}%

    \ifsixrowsmonth
      \dotfill\par
      \dotfill\par
    \else
      \dotfill\par
      \dotfill\par
      \dotfill\par
      \dotfill\par
    \fi

  \end{minipage}%
}

\newcommand\photoAndNotesFmt{%
  \renewcommand*\monthFmt{\LARGE}%
  \renewcommand*\yearFmt{\LARGE}%
  \renewcommand*\dayLetterColor{}%
  \renewcommand*\dayLetterFmt{\small}%
  \renewcommand*\dayLetterTextFmt[1]{\tiny\textls*{\MakeUppercase{##1}}}%
  \renewcommand*\dayTextFmt{\small}%
  \renewcommand*\quoteFmt{\centering}%
  \renewcommand*\headingFmt{\centering}%
  \renewcommand*\calendarFmt{\centering}%
  \renewcommand*\eventsFmt{\setlength{\parindent}{0pt}\raggedright\fontsize{6}{8}\selectfont}%
  \setlength{\@t@calendar@minimumHeight}{\calPaperHeight - 30mm}%
  \setlength{\@t@calendar@hmargin}{20pt}%
  % white space to allow:
  % - month and year label
  % - notepad area
  % - extra white space
  \setlength{\@t@calendar@verticalSpacing}{30mm}%
}
\end{verbatim}

\subsection{Init}
\label{sec:orgb4a0701}

\begin{verbatim}
\newcommand\@wall@photoAndNotesLayout[2][]{%
\makeatletter
\renewcommand*\theMonthName{#2}
\@wall@layout@reset
\photoAndNotesFmt
\pgfkeys{/Photo/#2/disabled/.get=\@val}
\ifdefstring{\@val}{true}{\PhotoEnabledfalse}{\PhotoEnabledtrue}
\end{verbatim}

\subsection{Lengths and sizes}
\label{sec:orgef3d9b4}

Bleed:

\begin{verbatim}
\pgfkeys{/Photo/#2/bleed/.get=\@val}
\setlength{\@t@bleed}{\@val}
\end{verbatim}

\begin{verbatim}
\def\@t@monthnum{\monthToNum{#2}}
\end{verbatim}

Determine if this month needs six rows:

\begin{verbatim}
\settowidth{\@tmp@z}{%
\begin{tikzpicture}
  \calendar [
    dates=\CalendarYear-\@t@monthnum-01 to \CalendarYear-\@t@monthnum-last,
    execute at begin day scope={
      \ifdate{six rows month}{\global\sixrowsmonthtrue}{\global\sixrowsmonthfalse}
    },
  ];
\end{tikzpicture}
}
\end{verbatim}

Calendar height:

Default height to fit:

\begin{itemize}
\item day headings
\item days in a grid, 6 rows
\item events
\item bottom bleed
\end{itemize}

\begin{verbatim}
\setlength{\@t@calendar@height}{\@t@calendar@minimumHeight + \@t@bleed}

% See if there was a height given in the options
\pgfkeys{/Calendar/#2/minimum height/.get=\@val}
\ifx\@val\empty \relax
\else
  \setlength{\@t@calendar@height}{\@val + \@t@bleed}
\fi
\end{verbatim}

Calculate offsets:

\begin{verbatim}
\setlength{\@tmp@a}{\@t@calendar@verticalSpacing}
\setlength{\@tmp@b}{\@t@calendar@height -\@tmp@a}
\setlength{\@t@calendar@dayYshift}{0.1666\@tmp@b}% 1/6 = 0.1666

\setlength{\@t@calendar@gridHeightSixRows}{\@tmp@b}
\setlength{\@t@calendar@gridHeightFiveRows}{\@tmp@b -0.1666\@tmp@b}

% NOTE: the -4pt and -2pt offset is somehow necessary for the sides to align
% with the edges
\setlength{\@t@rightOffset}{\@t@bleed +\@t@calendar@hmargin -4pt}
\setlength{\@t@minipageWidth}{\calPaperWidth -2\@t@calendar@hmargin -2pt}

\setlength{\@t@calendar@dayXshift}{0.1428\@t@minipageWidth}% 1/7 = 0.1428
\end{verbatim}

\subsection{Set the coffin contents}
\label{sec:orgcf41083}

Photo page wrap:

\begin{verbatim}
\SetHorizontalCoffin\@wall@photoPageWrap{%
  \color{white}%
  \rule{\textwidth}{0pt}%
  \rule{0pt}{\textheight}%
}
\end{verbatim}

Notes page wrap:

\begin{verbatim}
\SetHorizontalCoffin\@wall@notesPageWrap{%
  \color{white}%
  \rule{\textwidth}{0pt}%
  \rule{0pt}{\textheight}%
}
\end{verbatim}

Photo:

\begin{verbatim}
\ifPhotoEnabled
\pgfkeys{/Photo/#2/file/.get=\@t@file}

\SetHorizontalCoffin\@wall@photo{%
  \placeholder[fill=photo-frame]{hasvarnish}{%
    \@wall@photo@putPhoto{\@t@file}%
  }%
}
\fi
\end{verbatim}

Quote:

\begin{verbatim}
\ifPhotoEnabled
\SetHorizontalCoffin\@wall@quote{%
  \placeholder[fill=quote-frame]{}{%
    \begin{minipage}{\linewidth}%
      \quoteFmt
      \pgfkeys{/Quote/#2/text/.get=\@val}%
      \@val%
    \end{minipage}%
  }%
}
\fi
\end{verbatim}

Notepad:

\begin{verbatim}
\SetHorizontalCoffin\@wall@notepad{%
  \placeholder[fill=quote-frame]{}{%
    \notepadContent%
  }%
}
\end{verbatim}

Calendar:

\begin{verbatim}
\SetHorizontalCoffin\@wall@calendar{%
\ifvarnishmask\relax
\else
\begin{tikzpicture}

\node (bg) [
  fill = calendarbg,
  opacity = 1,
  minimum width = {\calPaperWidth + 2\@t@bleed},
  anchor=north west,
  /Calendar/#2/bg,
  % override the style, in case bleed was set above
  minimum height = {\@t@calendar@height},
] at (0,0) {};

\node (heading) [
  below right=10pt and {\@t@rightOffset} of bg.north west,
  anchor=north west,
] {%
\placeholder[fill=heading-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\headingFmt
{\monthFmt\@tr@monthNumName{\@t@monthnum}}
\hfill
\strcmpblank{\CalendarAltYear}{%
   {\yearFmt\CalendarYear}%
}{%
  {\yearFmt\CalendarYear/\CalendarAltYear}%
}%
\end{minipage}%
}%
};

\node (calendar) [
  below right=35pt and {\@t@rightOffset} of bg.north west,
  anchor=north west,
] {%
\placeholder[fill=calendar-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\calendarFmt
\hspace*{-5pt}% FIXME
\tikz{\tikzMonthCalendar@photoAndNotes{\@t@monthnum};}%
\end{minipage}%
}%
};

\node (events) [
  above right=10mm and {\@t@rightOffset} of bg.south west,
  anchor=south west,
] {%
\placeholder[fill=events-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\eventsFmt
\pgfkeys{/Events/#2/text/.get=\@val}%
\@val%
\end{minipage}%
}%
};

\end{tikzpicture}%
\fi
}% \SetHorizontalCoffin
\end{verbatim}

\subsection{Join the coffins}
\label{sec:orgd4e58d5}

\begin{verbatim}
\ifPhotoEnabled
\@wall@photo@setYOffset

\pgfkeys{/Photo/#2/xOffset/.get=\@val}
\addtolength{\@t@xOffset}{\@val}
\pgfkeys{/Photo/#2/yOffset/.get=\@val}
\addtolength{\@t@yOffset}{\@val}

\JoinCoffins*\@wall@photoPageWrap[l,t]\@wall@photo[l,t](-\spinemargin -\@t@bleed + \@t@xOffset, \uppermargin + \@t@bleed + \@t@yOffset)

\pgfkeys{/Quote/#2/xOffset/.get=\@val}
\setlength{\@t@xOffset}{\@val}
\pgfkeys{/Quote/#2/yOffset/.get=\@val}
\setlength{\@t@yOffset}{\@val}

\JoinCoffins*\@wall@photoPageWrap[l,t]\@wall@quote[l,t](\@t@xOffset, \@t@yOffset)
\fi

% Calendar is aligned to the top of the notes page.

\JoinCoffins*\@wall@notesPageWrap[hc,t]\@wall@calendar[hc,t](0pt, 0pt)

% Notepad is aligned to the bottom of the notes page.

\JoinCoffins*\@wall@notesPageWrap[hc,b]\@wall@notepad[hc,b](0pt, 0pt)

\makeatother
\end{verbatim}

\subsection{Typeset}
\label{sec:orgd0e7514}

\begin{verbatim}
\ifPhotoEnabled
\clearpage
\TypesetCoffin\@wall@photoPageWrap%
\fi
\clearpage
\TypesetCoffin\@wall@notesPageWrap%
}% \@wall@photoAndNotesLayout
\end{verbatim}

\subsection{Tikz calendar}
\label{sec:orgc816799}

\begin{verbatim}
#1 = number of month with leading zero
\end{verbatim}


\begin{verbatim}
\newcommand*{\tikzMonthCalendar@photoAndNotes}[1]{%
\pgfkeys{/Events/\monthName{#1}/marks/.get=\@eventmarks}%
\calendar (cal#1) [rigel, dates=\CalendarYear-#1-01 to \CalendarYear-#1-last] \@eventmarks;%
}
\end{verbatim}

\section{Large Calendar, \textbackslash @wall@largeCalendarLayout}
\label{sec:orge83428f}
\subsection{Setup formatting hooks}
\label{sec:org03aaf31}

\begin{verbatim}
\newcommand\largeCalendarFmt{%
  \renewcommand*\monthFmt{\LARGE}%
  \renewcommand*\yearFmt{\LARGE}%
  \renewcommand*\dayLetterColor{}%
  \renewcommand*\dayLetterFmt{\small}%
  \renewcommand*\dayLetterTextFmt[1]{\tiny\textls*{\MakeUppercase{##1}}}%
  \renewcommand*\dayTextFmt{\small}%
  \renewcommand*\quoteFmt{}%
  \renewcommand*\headingFmt{\centering}%
  \renewcommand*\calendarFmt{\centering}%
  \renewcommand*\eventsFmt{\setlength{\parindent}{0pt}\raggedright\fontsize{6}{8}\selectfont}%
  \setlength{\@t@calendar@minimumHeight}{112mm}%
  \setlength{\@t@calendar@hmargin}{20pt}%
  % white space to allow:
  % - month and year label
  % - notepad area
  % - extra white space
  \setlength{\@t@calendar@verticalSpacing}{30mm}%
}
\end{verbatim}

\subsection{Init}
\label{sec:orgd0c393b}

\begin{verbatim}
\newcommand\@wall@largeCalendarLayout[2][]{%
\makeatletter
\renewcommand*\theMonthName{#2}
\@wall@layout@reset
\largeCalendarFmt
\end{verbatim}

\subsection{Lengths and sizes}
\label{sec:org8061ef0}

Bleed:

\begin{verbatim}
\pgfkeys{/Photo/#2/bleed/.get=\@val}
\setlength{\@t@bleed}{\@val}
\end{verbatim}

\begin{verbatim}
\def\@t@monthnum{\monthToNum{#2}}
\end{verbatim}

Determine if this month needs six rows:

\begin{verbatim}
\settowidth{\@tmp@z}{%
\begin{tikzpicture}
  \calendar [
    dates=\CalendarYear-\@t@monthnum-01 to \CalendarYear-\@t@monthnum-last,
    execute at begin day scope={
      \ifdate{six rows month}{\global\sixrowsmonthtrue}{\global\sixrowsmonthfalse}
    },
  ];
\end{tikzpicture}
}
\end{verbatim}

Calendar height:

Default height to fit:

\begin{itemize}
\item day headings
\item days in a grid, 6 rows
\item events
\item bottom bleed
\end{itemize}

\begin{verbatim}
\setlength{\@t@calendar@height}{\@t@calendar@minimumHeight + \@t@bleed}

% See if there was a height given in the options
\pgfkeys{/Calendar/#2/minimum height/.get=\@val}
\ifx\@val\empty \relax
\else
  \setlength{\@t@calendar@height}{\@val + \@t@bleed}
\fi
\end{verbatim}

Calculate offsets:

\begin{verbatim}
\setlength{\@tmp@a}{\@t@calendar@verticalSpacing}
\setlength{\@tmp@b}{\@t@calendar@height -\@tmp@a}
\setlength{\@t@calendar@dayYshift}{0.1666\@tmp@b}% 1/6 = 0.1666

\setlength{\@t@calendar@gridHeightSixRows}{\@tmp@b}
\setlength{\@t@calendar@gridHeightFiveRows}{\@tmp@b -0.1666\@tmp@b}

% NOTE: the -4pt and -2pt offset is somehow necessary for the sides to align
% with the edges
\setlength{\@t@rightOffset}{\@t@bleed +\@t@calendar@hmargin -4pt}
\setlength{\@t@minipageWidth}{\calPaperWidth -2\@t@calendar@hmargin -2pt}

\setlength{\@t@calendar@dayXshift}{0.1428\@t@minipageWidth}% 1/7 = 0.1428
\end{verbatim}

\subsection{Set the coffin contents}
\label{sec:org618c451}

Photo wrap:

\begin{verbatim}
\SetHorizontalCoffin\@wall@pageWrap{%
  \color{white}%
  \rule{\textwidth}{0pt}%
  \rule{0pt}{\textheight}%
}
\end{verbatim}

Photo:

\begin{verbatim}
\pgfkeys{/Photo/#2/file/.get=\@t@file}

\SetHorizontalCoffin\@wall@photo{%
  % Varnishmask placeholder is in 'put photo/left' and 'put photo/right'.
  \@wall@photo@putPhoto{\@t@file}%
}
\end{verbatim}

Quote:

\begin{verbatim}
\SetHorizontalCoffin\@wall@quote{%
\ifvarnishmask\relax
\else
  \placeholder[fill=quote-frame]{}{%
    \pgfkeys{/Quote/#2/text/.get=\@val}%
    \@wall@quote@putQuote{\@val}%
  }%
\fi
}
\end{verbatim}

Calendar:

\begin{verbatim}
\SetHorizontalCoffin\@wall@calendar{%
\ifvarnishmask\relax
\else
\begin{tikzpicture}

\node (bg) [
  fill = calendarbg,
  opacity = 1,
  minimum width = {\calPaperWidth + 2\@t@bleed},
  anchor=north west,
  /Calendar/#2/bg,
  % override the style, in case bleed was set above
  minimum height = {\@t@calendar@height},
] at (0,0) {};

\node (heading) [
  below right=2pt and {\@t@rightOffset} of bg.north west,
  anchor=north west,
] {%
\placeholder[fill=heading-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\headingFmt
{\monthFmt\@tr@monthNumName{\@t@monthnum}}
\hfill
\strcmpblank{\CalendarAltYear}{%
   {\yearFmt\CalendarYear}%
}{%
  {\yearFmt\CalendarYear/\CalendarAltYear}%
}%
\end{minipage}%
}%
};

\node (calendar) [
  below right=35pt and {\@t@rightOffset} of bg.north west,
  anchor=north west,
] {%
\placeholder[fill=calendar-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\calendarFmt
\hspace*{-5pt}% FIXME
\tikz{\tikzMonthCalendar@largeCalendar{\@t@monthnum};}%
\end{minipage}%
}%
};

\node (events) [
  below=105mm of bg.north,
  anchor=north,
] {%
\placeholder[fill=events-frame]{}{%
\begin{minipage}{\@t@minipageWidth}%
\eventsFmt
\pgfkeys{/Events/#2/text/.get=\@val}%
\@val%
\end{minipage}%
}%
};

\end{tikzpicture}%
\fi
}% \SetHorizontalCoffin
\end{verbatim}

\subsection{Join the coffins}
\label{sec:org73aec18}

\begin{verbatim}
\@wall@photo@setYOffset

\pgfkeys{/Photo/#2/xOffset/.get=\@val}
\addtolength{\@t@xOffset}{\@val}
\pgfkeys{/Photo/#2/yOffset/.get=\@val}
\addtolength{\@t@yOffset}{\@val}

\JoinCoffins*\@wall@pageWrap[l,t]\@wall@photo[l,t](-\spinemargin -\@t@bleed + \@t@xOffset, \uppermargin + \@t@bleed + \@t@yOffset)

\pgfkeys{/Quote/#2/xOffset/.get=\@val}
\setlength{\@t@xOffset}{\@val}
\pgfkeys{/Quote/#2/yOffset/.get=\@val}
\setlength{\@t@yOffset}{\@val}

\JoinCoffins*\@wall@pageWrap[l,t]\@wall@quote[l,t](-\spinemargin -\@t@bleed + \@t@xOffset, \uppermargin + \@t@bleed + \@t@yOffset)

\JoinCoffins*\@wall@pageWrap[l,b]\@wall@calendar[l,t](-\spinemargin -\@t@bleed, \textheight +\uppermargin -\paperheight -\@t@bleed +\@t@calendar@height +10mm)

\makeatother
\end{verbatim}

\subsection{Typeset}
\label{sec:org6f1832b}

\begin{verbatim}
\clearpage
\TypesetCoffin\@wall@pageWrap%
}% \@wall@largeCalendarLayout
\end{verbatim}

\subsection{Tikz calendar}
\label{sec:org117e2d0}

\begin{verbatim}
#1 = number of month with leading zero
\end{verbatim}


\begin{verbatim}
\newcommand*{\tikzMonthCalendar@largeCalendar}[1]{%
\pgfkeys{/Events/\monthName{#1}/marks/.get=\@eventmarks}%
\calendar (cal#1) [rigel, dates=\CalendarYear-#1-01 to \CalendarYear-#1-last] \@eventmarks;%
}
\end{verbatim}

\section{Tikz styles}
\label{sec:org5bdadf2}
\subsection{day letter headings}
\label{sec:orgd8fcce4}

\begin{verbatim}
\tikzstyle{day letter headings}=[%
  day heading/.style={black!90},
  execute before day scope={%
    \ifdate{day of month=1}{%
      \pgfmathsetlength\pgf@xa{\tikz@lib@cal@xshift}%
      \pgfmathsetlength\pgf@ya{\tikz@lib@cal@yshift}%
      \foreach \d in {0,1,2,3,4,5,6} {%
	\pgf@xa=\d\pgf@xa%
	\pgftransformxshift{\pgf@xa}%
	\pgftransformyshift{\pgf@ya}%
	\pgftransformyshift{4pt}%
	\node (d\d) [anchor=base, day heading] {\dayLetterFmt\@tr@dayLetter{\d}};%
      };%
    }{}%
  },%
]
\end{verbatim}

\subsection{day fullday headings}
\label{sec:orgd0d4eb7}

\begin{verbatim}
\tikzstyle{day fullday headings}=[%
  day heading/.style={black!90},
  execute before day scope={%
    \ifdate{day of month=1}{%
      \pgfmathsetlength\pgf@xa{\tikz@lib@cal@xshift}%
      \pgfmathsetlength\pgf@ya{\tikz@lib@cal@yshift}%
      \foreach \d in {0,1,2,3,4,5,6} {%
	\pgf@xa=\d\pgf@xa%
	\pgftransformxshift{\pgf@xa}%
	\pgftransformyshift{\pgf@ya}%
	\pgftransformyshift{4pt}%
	\node (d\d) [anchor=base, day heading] {\dayLetterTextFmt{\@tr@dayName{\d}}};%
      };%
    }{}%
  },%
]
\end{verbatim}

\subsection{days grid}
\label{sec:org23bab34}

\begin{verbatim}
\newcount\gridRows
\newcount\gridLines
\newcount\n

\tikzstyle{days grid}=[%
  execute before day scope={%
    \ifdate{day of month=1}{%
      %
      % Determine if the grid is five or six rows
      %
      % 31 day months
      \ifdate{between=01-01 and 01-31, between=03-01 and 03-31, between=05-01 and 05-31, between=07-01 and 07-31, between=08-01 and 08-31, between=10-01 and 10-31, between=12-01 and 12-31}{%
	\ifdate{Saturday,Sunday}{%
	  \gridRows=6%
	  \setlength\@t@calendar@gridHeight{\@t@calendar@gridHeightSixRows}%
	}{%
	  \gridRows=5%
	  \setlength\@t@calendar@gridHeight{\@t@calendar@gridHeightFiveRows}%
	}
      }{
      % 30 day months and February
	\ifdate{between=02-01 and 02-last}{%
	  \gridRows=5%
	  \setlength\@t@calendar@gridHeight{\@t@calendar@gridHeightFiveRows}%
	}{%
	  \ifdate{Sunday}{%
	    \gridRows=6%
	    \setlength\@t@calendar@gridHeight{\@t@calendar@gridHeightSixRows}%
	  }{%
	    \gridRows=5%
	    \setlength\@t@calendar@gridHeight{\@t@calendar@gridHeightFiveRows}%
	  }
	}
      }
      %
      % Horizontal lines
      %
      \gridLines=\gridRows
      \ifGridSurround
	\advance\gridLines by 1
	\n=0
	\draw [
	  gridcolor,
	  line width=0.3pt,
	  xshift=-0.5\@t@calendar@dayXshift,
	  yshift=0.5\@t@calendar@dayYshift,
	] (0,{-\n\@t@calendar@dayYshift}) -- (7\@t@calendar@dayXshift,{-\n\@t@calendar@dayYshift});
      \fi
      \foreach \n in {1,2,3,4,5,6} {
	\ifnum\n<\gridLines
	  \draw [
	    gridcolor,
	    line width=0.3pt,
	    xshift=-0.5\@t@calendar@dayXshift,
	    yshift=0.5\@t@calendar@dayYshift,
	  ] (0,{-\n\@t@calendar@dayYshift}) -- (7\@t@calendar@dayXshift,{-\n\@t@calendar@dayYshift});
	\fi
      }
      %
      % Vertical lines
      %
      \gridLines=7
      \ifGridSurround
	\advance\gridLines by 1
	\n=0
	\draw [
	  gridcolor,
	  line width=0.3pt,
	  xshift=-0.5\@t@calendar@dayXshift,
	  yshift=0.5\@t@calendar@dayYshift,
	] ({\n\@t@calendar@dayXshift},0) -- ({\n\@t@calendar@dayXshift},{-\gridRows\@t@calendar@dayYshift});
      \fi
      \foreach \n in {1,2,3,4,5,6,7} {
	\ifnum\n<\gridLines
	  \draw [
	    gridcolor,
	    line width=0.3pt,
	    xshift=-0.5\@t@calendar@dayXshift,
	    yshift=0.5\@t@calendar@dayYshift,
	  ] ({\n\@t@calendar@dayXshift},0) -- ({\n\@t@calendar@dayXshift},{-\gridRows\@t@calendar@dayYshift});
	\fi
      }
      %
      % If we are not drawing the surrounding lines, it looks better to hide
      % some of the top and bottom edges
      %
      \ifGridSurround\relax
      \else
	\draw [
	  color=white,
	  line width=6pt,
	  xshift=-0.5\@t@calendar@dayXshift,
	  yshift={0.5\@t@calendar@dayYshift -1pt},
	] (0,0) -- (7\@t@calendar@dayXshift,0);
	\draw [
	  color=white,
	  line width=6pt,
	  xshift=-0.5\@t@calendar@dayXshift,
	  yshift={0.5\@t@calendar@dayYshift +1pt},
	] (0,-\gridRows\@t@calendar@dayYshift) -- (7\@t@calendar@dayXshift,-\gridRows\@t@calendar@dayYshift);
      \fi
    }{}%
  }
]
\end{verbatim}

\subsection{headings background rule}
\label{sec:org6a23a5b}

\begin{verbatim}
\tikzstyle{headings background rule}=[
  background rule/.style={black!90, line width=0.3pt, yshift={0.3\@t@calendar@dayYshift -3pt}},
  execute before day scope={%
    \ifdate{day of month=1}{%
      \draw [
	xshift=-0.5\@t@calendar@dayXshift,
	yshift=0.5\@t@calendar@dayYshift,
	background rule,
      ] (0,0) -- (7\@t@calendar@dayXshift,0);
    }{}%
  }
]
\end{verbatim}

\subsection{headings background bar}
\label{sec:org9d53f6b}

\begin{verbatim}
\tikzstyle{headings background bar}=[
  headings background rule,
  background rule/.style={black!20, line width=10pt, yshift={0.3\@t@calendar@dayYshift +3.5pt}},
]
\end{verbatim}

\section{Tikz calendar styles}
\label{sec:org7a2e0af}
\subsection{Betelgeuse, days in a grid}
\label{sec:orgc21ffc7}

(Alpha Orionis)

\begin{verbatim}
\tikzstyle{betelgeuse}=[
  days grid,
  week list,
  day xshift=\@t@calendar@dayXshift,
  day yshift=\@t@calendar@dayYshift,
  headings background bar,
  day letter headings,
  day heading/.style={black!90, yshift={-0.3\@t@calendar@dayYshift}},
  every day/.append style={anchor=base, inner xsep=0pt, yshift={-0.25\baselineskip}},
  day text={\dayTextFmt\%d-},
]
\end{verbatim}

\subsection{Rigel, days in a grid, inline notes}
\label{sec:orgb541066}

(Beta Orionis)

Command to print day number, so that it can be reused outside the day code block:

\begin{verbatim}
% #1 : day node name to position at, \pgfcalendarsuggestedname in the day code block
% #2 : this node name postfix, -daynumber in the day code block
% #3 : day number, use \tikzdaytext in the day code block
\newcommand*\calDayNumberNode[3]{%
    \node (#1#2) [
      below right=3.5pt and 8pt of #1.north west,
      anchor=north west,
      inner sep=0pt,
    ] {#3};
}
\end{verbatim}

\begin{verbatim}
\tikzstyle{rigel}=[
  days grid,
  week list,
  day xshift=\@t@calendar@dayXshift,
  day yshift=\@t@calendar@dayYshift,
  day fullday headings,
  day heading/.style={black!90, yshift={-0.3\@t@calendar@dayYshift}},
  every day/.append style={anchor=base, inner xsep=0pt, yshift={-0.25\baselineskip}},
  execute at begin day scope={
    \ifdate{Sunday}{\def\dayLetterColor{\color{sunday}}}{\def\dayLetterColor{\color{weekday}}}%
  },
  day text={\dayTextFmt\dayLetterColor\%d-},
  day code={%
    \node [
      minimum width=\@t@calendar@dayXshift,
      minimum height=\@t@calendar@dayYshift,
      name=\pgfcalendarsuggestedname,
      every day,
    ] {};%
    \calDayNumberNode{\pgfcalendarsuggestedname}{-daynumber}{\tikzdaytext}%
  },
]
\end{verbatim}

\subsection{Aldebaran, like Rigel but without heading bg bar}
\label{sec:org461aa09}

\begin{verbatim}
\tikzstyle{aldebaran}=[
  days grid,
  week list,
  day xshift=\@t@calendar@dayXshift,
  day yshift=\@t@calendar@dayYshift,
  day letter headings,
  day heading/.style={black!90, yshift={-0.3\@t@calendar@dayYshift}},
  every day/.append style={anchor=base, inner xsep=0pt, yshift={-0.25\baselineskip}},
  day text={\dayTextFmt\%d-},
]
\end{verbatim}

\subsection{Alnitak, days in one line}
\label{sec:orgefe3e66}

(Zeta Orionis)

\begin{verbatim}
\tikzstyle{alnitak}=[
  day list right,
  day xshift={0pt},
  every month/.append style={anchor=base, inner xsep=0pt, yshift=4mm, xshift=-\widthof{\space}},
  day text={\dayTextFmt\%d-},
  every day/.append style={anchor=base, inner xsep=0pt},
  execute before day scope={
    %
    % === Moving the day number ===
    %
    % A small offset seems to improve the result, the last day gets closer to the end of the linewidth
    \pgftransformxshift{0.01em}
    \pgfcalendarjuliantodate{\pgfcalendarendjulian}{\currentyear}{\currentmonth}{\lastday}
    % Width of month day digits from 1 - 28
    \setlength{\@tmp@a}{\widthof{12345678910111213141516171819202122232425262728}}
    \setlength{\@tmp@b}{\widthof{30}}
    \pgfmathparse{(\linewidth - \@tmp@a - \@tmp@b * (\lastday-28)) / \lastday}
    \pgftransformxshift{\pgfmathresult}
    \let\%=\pgfcalendarshorthand
    \setlength{\@tmp@a}{\widthof{\%d-}}
    \pgftransformxshift{\@tmp@a}
    %
    % === Weekday letter above the day ===
    %
    \ifdate{weekend}{\def\dayLetterColor{\color{weekend}}}{\def\dayLetterColor{\color{weekday}}}%
    \node[anchor=base,yshift=5.5mm,inner sep=0pt]{%
      \dayLetterColor\dayLetterFmt\@tr@dayLetter{\pgfcalendarcurrentweekday}%
    };%
  },
]
\end{verbatim}

\chapter{Year Planner}
\label{sec:org637b4c5}
\section{Tikz calendar styles}
\label{sec:orgf6d2a8d}
\subsection{Year Planner Portrait}
\label{sec:org17ac9dd}

\begin{verbatim}
\newcommand\plannerPortraitMonthFmt{\fontsize{11}{11}\selectfont\color{darkgold}}
\newcommand\plannerPortraitDayFmt{\fontsize{10}{10}\selectfont\color{plannerdatenum}}

\tikzstyle{year planner portrait}=[
  week list,
  month text={\plannerPortraitMonthFmt\@tr@monthNumName{\pgfcalendarcurrentmonth}},
  day text={\plannerPortraitDayFmt\%d-},
  every month/.append style={%
    anchor=south,
    inner xsep=0pt,
    yshift=5mm,
    xshift=2.5mm,
  },
  day letter headings,
  day heading/.style={gray, xshift=0pt, scale=0.85},
  month label above centered,
  every day/.style={anchor=mid},
]
\end{verbatim}

\subsection{Year Planner Landscape}
\label{sec:orgf67a4ae}

\begin{verbatim}
\newcommand\plannerLandscapeDateDayFont{}
\newcommand\plannerLandscapeDayFont{}
\newcommand\plannerLandscapeMonthFont{}

\newcommand\plannerLandscapeMonthFmt{%
  \plannerLandscapeMonthFont%
  \fontsize{15}{18}\selectfont%
  \color{gold}\bfseries%
}

\newcommand\plannerLandscapeDayFmt{%
  \plannerLandscapeDayFont%
  \fontsize{10}{12}\selectfont%
}

\newcommand*\plannerLandscapeDateDayFormat[1]{%
  \plannerLandscapeDateDayFont%
  \fontsize{8}{11}\selectfont%
  #1%
}

\newcommand\plannerLandscapeBeginDayScopeHook{%
  \ifdate{weekend}{\color{black!60}}{}
}

\newlength\plannerLandscapeDayXShift
\newlength\plannerLandscapeMonthYShift

% Assuming 25mm to fit 'September'
\setlength{\@tmp@a}{\calPaperWidth - \@wall@leftMargin - \@wall@rightMargin - 25mm}
% Max week shift is 6 = Sunday. 31 days + 6 = 37. 1/37 = 0.027
\setlength{\plannerLandscapeDayXShift}{0.027\@tmp@a}

% Assuming 10mm for day headings (M T W...) and some padding
\setlength{\@tmp@a}{\calPaperHeight - \@wall@topMargin - \@wall@bottomMargin - 10mm}
% 1/12 = 0.0833
\setlength{\plannerLandscapeMonthYShift}{0.0833\@tmp@a}

\tikzstyle{year planner landscape}=[
  month list,
  day xshift=\plannerLandscapeDayXShift,
  month yshift=\plannerLandscapeMonthYShift,
  every month/.append style={anchor=base, inner xsep=0pt},
  month text={\plannerLandscapeMonthFmt \%mt},
  day text={\plannerLandscapeDayFmt \%d-},
  every day/.append style={anchor=base, inner xsep=0pt},
  month label left,
  execute at begin day scope={
    \plannerLandscapeBeginDayScopeHook
    % Weekday headers in January
    \ifdate{between=01-01 and 01-31}{
      \def\l{\ifcase\pgfcalendarcurrentweekday M\or T\or W\or T\or F\or S\or S\fi}%
      \ifdate{weekend}{\def\daylabelcolor{gold}}{\def\daylabelcolor{black}}%
      \node[anchor=south,yshift=5mm,inner sep=0pt]{\color{\daylabelcolor}\plannerLandscapeDateDayFormat{\l}};%
    }{}
    % Weekday headers in December
    \ifdate{between=12-01 and 12-31}{
      \pgftransformyshift{-3mm}%
      \def\l{\ifcase\pgfcalendarcurrentweekday M\or T\or W\or T\or F\or S\or S\fi}%
      \ifdate{weekend}{\def\daylabelcolor{gold}}{\def\daylabelcolor{black}}%
      \node[anchor=south,yshift=5mm,inner sep=0pt]{\color{\daylabelcolor}\plannerLandscapeDateDayFormat{\l}};%
    }{}
  }
]
\end{verbatim}

\subsection{Year Planner Landscape Grid}
\label{sec:org0506746}

\begin{verbatim}
\newcommand\plannerGridMonthFont{}
\newcommand\plannerGridDateDayFont{}
\newcommand\plannerGridNotesFont{}
\newcommand\plannerGridDayFont{}
\newcommand\plannerGridYearNumberFont{}

\newcommand\plannerGridYearNumberFmt{%
  \plannerGridYearNumberFont%
  \fontsize{11}{11}\selectfont%
  \color{white}%
}

\newcommand\plannerGridMonthFmt{%
  \plannerGridMonthFont%
  \fontsize{13}{13}\selectfont%
  \color{white}%
}

\newcommand\plannerGridDayFmt{%
  \plannerGridDayFont%
  \fontsize{11}{11}\selectfont%
}

\newcommand\plannerGridDateDayFmt{%
  \plannerGridDateDayFont%
  \fontsize{9}{9}\selectfont%
  \color{black!80}%
}

\newcommand{\plannerGridNotesFmt}{%
  \plannerGridNotesFont%
  \fontsize{11}{11}\selectfont%
}

\newcommand\plannerGridBeginDayScopeHook{%
  \ifdate{weekend}{\color{black!60}}{}
}

\newlength\plannerGridColXShift
\newlength\plannerGridRowYShift

\newlength\plannerGridCalendarWidth
\newlength\plannerGridCalendarHeight

\newlength\plannerGridDayHeadingsHeight
\newlength\plannerGridMonthNamesWidth

\newlength\plannerGridNotesHeight
\setlength{\plannerGridNotesHeight}{10mm}

\setlength{\plannerGridCalendarWidth}{\calPaperWidth - \@wall@leftMargin - \@wall@rightMargin}
\setlength{\plannerGridCalendarHeight}{\calPaperHeight - \@wall@topMargin - \@wall@bottomMargin - \plannerGridNotesHeight}

\setlength{\plannerGridDayHeadingsHeight}{10mm}
\setlength{\plannerGridMonthNamesWidth}{10mm}

\setlength{\@tmp@a}{\plannerGridCalendarWidth - \plannerGridMonthNamesWidth}
% 37 columns. 1/37 = 0.027. Max week shift is 6 = Sunday. 31 days + 6 = 37.
\setlength{\plannerGridColXShift}{0.027\@tmp@a}

\setlength{\@tmp@a}{\plannerGridCalendarHeight - 2\plannerGridDayHeadingsHeight}
% 12 rows. 1/12 = 0.0833
\setlength{\plannerGridRowYShift}{0.0833\@tmp@a}

\newcounter{verticalCount}

\tikzstyle{year planner landscape grid days}=[
  month list,
  day xshift=\plannerGridColXShift,
  month yshift=\plannerGridRowYShift,
  day text={\plannerGridDayFmt \%d-},
  every day/.append style={anchor=base, yshift=-4pt, inner xsep=0pt},
  execute at begin day scope={%
    % White fill to cover the page background color
    \node (cell) [
      rectangle,
      fill = white,
      minimum height = \plannerGridRowYShift - 1pt,
      minimum width = \plannerGridColXShift - 1pt,
      xshift = -0.5\plannerGridColXShift,
      yshift = 4.5pt,
    ] {};%
    %
    \ifdate{Monday}{%
      \node (a) [above left = 15pt and -3.5pt of cell.west] {};
      \node (b) [below left = 15pt and -3.5pt of cell.west] {};
      \node (c) [right = 10pt of cell.west] {};
      \path [on layer = one, fill = pagebgcolor] (a.south) -- (b.north) -- (c.west) -- (a.south);%
    }{}%
    %
    \ifdate{Sunday}{%
      \node (a) [above left = 15pt and {-3.5pt + 1pt} of cell.east] {};
      \node (b) [below left = 15pt and {-3.5pt + 1pt} of cell.east] {};
      \node (c) [right = {10pt - 1pt} of cell.east] {};
      \path [on layer = two, fill = white] (a.south) -- (b.north) -- (c.west) -- (a.south);%
    }{}%
    %
    \plannerGridBeginDayScopeHook%
  },
]
\end{verbatim}

\subsection{Year Planner Compact}
\label{sec:org03a177d}

\begin{verbatim}
\newcommand\pf{}
\newcommand\plannerCompactDayFmt{\fontsize{9}{9}\selectfont}
\newcommand\plannerCompactMonthFmt{\fontsize{10}{10}\selectfont\color{darkgold}}
\newcommand\plannerCompactYearFmt{\plannerCompactMonthFmt}
\newcommand\plannerCompactWeekNumFmt{\itshape\fontsize{7}{7}\selectfont\color{textbody}}

\newcommand*\plannerCompactDateDayFormat[1]{\fontsize{8}{11}\selectfont #1}

\newcommand\plannerCompactBeginDayScopeHook{%
  \ifdate{weekend}{\color{weekend}}{\color{weekday}}
}

\newcount\weeknum

\tikzstyle{year planner compact}=[
  week list,
  month yshift=0pt,
  day text={\plannerCompactDayFmt\%d-},
  every day/.style={anchor=mid},%
  %
  execute before day scope={%
    %
    % Month corner node
    %
    \ifdate{day of month=1}{%
      \node (month-\pgfcalendarcurrentmonth-top-left) {};
    }{}
    %
    % Year number
    %
    \ifdate{equals=01-01}{%
      \node [
	above left = \tikz@lib@cal@yshift and 35pt of month-01-top-left.north west,
	inner sep = 0pt,
	anchor = south east,
      ] {\plannerCompactYearFmt\CalendarYear};%
    }{}
    %
    % Weekday headers in January
    %
    \ifdate{equals=01-01}{%
      \weeknum=1
      \pgfmathsetlength\pgf@xa{\tikz@lib@cal@xshift}%
      \pgfmathsetlength\pgf@ya{\tikz@lib@cal@yshift}%
      \foreach \d in {0,1,2,3,4,5,6} {%
	\pgf@xa=\d\pgf@xa%
	\pgftransformxshift{\pgf@xa}%
	\pgftransformyshift{\pgf@ya}%
	\pgftransformyshift{4pt}%
	\node (d\d) [anchor=base, inner sep=0pt] {%
	  \ifnum\d=5
	    \plannerCompactDateDayFormat{\color{weekend}\@tr@dayLetter{\d}}%
	  \else
	    \ifnum\d=6
	      \plannerCompactDateDayFormat{\color{weekend}\@tr@dayLetter{\d}}%
	    \else
	      \plannerCompactDateDayFormat{\@tr@dayLetter{\d}}%
	    \fi
	  \fi
	};%
      };%
    }{}%
    %
    % Week number
    %
    \ifnum\pgfcalendarcurrentweekday=0
      \node [
	anchor = east,
	xshift = -13pt,
	yshift = -0.5pt,
	inner sep = 0pt,
      ] {\parbox{6mm}{\centering\plannerCompactWeekNumFmt \the\weeknum.}};
      \advance\weeknum by 1
    \fi
    % When first week doesn't start on Monday
    \ifdate{equals=01-01}{%
      \ifnum\pgfcalendarcurrentweekday=0\relax
      \else
	\node [
	  anchor = east,
	  xshift = -13pt,
	  yshift = -0.5pt,
	  inner sep = 0pt,
	] {\parbox{6mm}{\centering\plannerCompactWeekNumFmt \the\weeknum.}};
	\advance\weeknum by 1
      \fi
    }{}%
  },%
  %
  execute at begin day scope={%
    %
    % Month name
    %
    \ifdate{day of month=1}{%
      \node [
	below left = 0pt and 35pt of month-\pgfcalendarcurrentmonth-top-left.north west,
	inner sep = 0pt,
	anchor = north west,
	rotate = -90,
      ] {%
	\plannerCompactMonthFmt\@tr@monthNumName{\pgfcalendarcurrentmonth}%
      };
    }{}
    %
    % Draw border lines between months
    %
    \ifdate{day of month=1}{%
      \ifdate{equals=01-01}{%
	% Don't draw border in January
      }{%
	\pgfmathsetlength\pgf@xa{\tikz@lib@cal@xshift}
	\pgfmathsetlength\pgf@ya{\tikz@lib@cal@yshift}
	%
	% No bottom and left edge on Mondays
	\ifnum\pgfcalendarcurrentweekday=0\relax
	\else
	  %
	  % Bottom border, from left side to the number
	  \n=\pgfcalendarcurrentweekday
	  \draw [
	    gridcolor,
	    line width = 0.5pt,
	  ] ({-\n\pgf@xa -0.5\pgf@xa}, -0.5\pgf@ya) -- (-0.5\pgf@xa, -0.5\pgf@ya);
	  % Vertical edge on the left side of the number
	  \draw [
	    gridcolor,
	    line width = 0.5pt,
	  ] (-0.5\pgf@xa, 0.5\pgf@ya + 0.25pt) -- (-0.5\pgf@xa, -0.5\pgf@ya - 0.25pt);
	\fi
	%
	% Top border, from the number to the right side
	\advance \n by -6
	\draw [
	  gridcolor,
	  line width = 0.5pt,
	] (-0.5\pgf@xa, 0.5\pgf@ya) -- ({-\n\pgf@xa +0.5\pgf@xa}, 0.5\pgf@ya);
      }%
    }{}%
    %
    \plannerCompactBeginDayScopeHook
  },
]
\end{verbatim}

\section{Helpers}
\label{sec:org5d1f2d7}

\begin{verbatim}
\newcommand\plannerMarksDayTextCSV{\@wall@eventsCsv}
\newcommand\plannerMarksNoteCSV{\@wall@eventsCsv}
\newcommand\plannerMarkDefaultsCsv{}

\newcommand\@wall@plm[1]{%
\luadirect{
require("wallcalendar-helpers.lua")
monthMarksDayText(\luastring{#1}, nil, \luastring{\plannerMarksDayTextCSV})
tex.sprint(';')
}}

\newcommand\@wall@plmYear{%
\luadirect{
require("wallcalendar-helpers.lua")
yearMarksDayText(tonumber(\CalendarYear), nil, \luastring{\plannerMarksDayTextCSV})
tex.sprint(';')
}}

\newcommand\@wall@plNotes{%
\luadirect{
require("wallcalendar-helpers.lua")
yearMarksNote(tonumber(\CalendarYear), nil, \luastring{\plannerMarksNoteCSV}, \luastring{\plannerMarkDefaultsCsv}, false)
}}

\newcommand\@wall@plNotesOneCalendar{%
\luadirect{
require("wallcalendar-helpers.lua")
yearMarksNote(tonumber(\CalendarYear), nil, \luastring{\plannerMarksNoteCSV}, \luastring{\plannerMarkDefaultsCsv}, true)
}}

\newcommand\plannerEvents{%
\parseYearEvents[filter pred = hasNote]%
}

\end{verbatim}

\section{\textbackslash YearPlannerPortrait}
\label{sec:orga0ca64f}

\begin{verbatim}
\newcommand\YearPlannerPortrait{%
\@wall@useDefaultMoons%
\begin{tikzpicture}[every calendar/.style={year planner portrait}]%
  \matrix[column sep=1.5em, row sep=5mm] {
    \calendar(cal01)[dates=\CalendarYear-01-01 to \CalendarYear-01-last] \@wall@plm{January};   \pgfmatrixnextcell
    \calendar(cal02)[dates=\CalendarYear-02-01 to \CalendarYear-02-last] \@wall@plm{February};  \pgfmatrixnextcell
    \calendar(cal03)[dates=\CalendarYear-03-01 to \CalendarYear-03-last] \@wall@plm{March};     \\
    \calendar(cal04)[dates=\CalendarYear-04-01 to \CalendarYear-04-last] \@wall@plm{April};     \pgfmatrixnextcell
    \calendar(cal05)[dates=\CalendarYear-05-01 to \CalendarYear-05-last] \@wall@plm{May};       \pgfmatrixnextcell
    \calendar(cal06)[dates=\CalendarYear-06-01 to \CalendarYear-06-last] \@wall@plm{June};      \\
    \calendar(cal07)[dates=\CalendarYear-07-01 to \CalendarYear-07-last] \@wall@plm{July};      \pgfmatrixnextcell
    \calendar(cal08)[dates=\CalendarYear-08-01 to \CalendarYear-08-last] \@wall@plm{August};    \pgfmatrixnextcell
    \calendar(cal09)[dates=\CalendarYear-09-01 to \CalendarYear-09-last] \@wall@plm{September}; \\
    \calendar(cal10)[dates=\CalendarYear-10-01 to \CalendarYear-10-last] \@wall@plm{October};   \pgfmatrixnextcell
    \calendar(cal11)[dates=\CalendarYear-11-01 to \CalendarYear-11-last] \@wall@plm{November};  \pgfmatrixnextcell
    \calendar(cal12)[dates=\CalendarYear-12-01 to \CalendarYear-12-last] \@wall@plm{December};  \\
  };
  \@wall@plNotes
\end{tikzpicture}%
}
\end{verbatim}

\section{\textbackslash YearPlannerLandscape}
\label{sec:org6538f2f}

\begin{verbatim}
\newcommand\YearPlannerLandscape{%
\@wall@usePlannerMoons%
\begin{tikzpicture}%
  \calendar (cal) [
    year planner landscape,
    dates=\CalendarYear-01-01 to \CalendarYear-12-31,
  ] \@wall@plmYear;
  \@wall@plNotesOneCalendar
\end{tikzpicture}%
}
\end{verbatim}

\section{\textbackslash YearPlannerLandscapeGrid}
\label{sec:orgebe96d0}

\begin{verbatim}
\newcommand\YearPlannerLandscapeGrid{%
\@wall@usePlannerMoons%
\begin{tikzpicture}

  % Background frame

  \node (bg) [
    rectangle,
    inner sep = 0pt,
    minimum width = \plannerGridCalendarWidth,
    minimum height = \plannerGridCalendarHeight,
  ] {};

  \foreach \x/\m in {1/\xJanShort, 2/\xFebShort, 3/\xMarShort, 4/\xAprShort,
    5/\xMayShort, 6/\xJunShort, 7/\xJulShort, 8/\xAugShort, 9/\xSepShort,
    10/\xOctShort, 11/\xNovShort, 12/\xDecShort}
  {
    \setlength{\@tmp@a}{\x\plannerGridRowYShift + \plannerGridDayHeadingsHeight}

    % Month labels

    \node [
      below = \@tmp@a of bg.north west,
      yshift = 0.5\plannerGridRowYShift,
      xshift = 0.5\plannerGridColXShift - 2pt,
      anchor = base,
      rotate = 90,
    ] {\plannerGridMonthFmt\MakeUppercase{\textls*{\m}}};

    % Horizontal lines

    \addtolength{\@tmp@a}{-\plannerGridRowYShift}

    \node (h-a-\x) [below = \@tmp@a of bg.north west] {};
    \node (h-b-\x) [below = \@tmp@a of bg.north east] {};
    \draw [gridcolor] (h-a-\x) -- (h-b-\x);
  }

  % 13th line
  \setlength{\@tmp@a}{12\plannerGridRowYShift + \plannerGridDayHeadingsHeight}
  \node (h-a-13) [below = \@tmp@a of bg.north west] {};
  \node (h-b-13) [below = \@tmp@a of bg.north east] {};
  \draw [gridcolor] (h-a-13) -- (h-b-13);

  % Year number in the corner
  \node [
    right = 0pt of bg.north west,
    xshift = 0.5\plannerGridMonthNamesWidth,
    yshift = -0.5\plannerGridDayHeadingsHeight - 5pt,
    anchor = base,
  ] {\plannerGridYearNumberFmt\CalendarYear};

  \setcounter{verticalCount}{1}

  \foreach \i in {0,1,2,3,4,5} {
    \foreach \j/\d in {
      0/\xMondayDayLetter,
      1/\xTuesdayDayLetter,
      2/\xWednesdayDayLetter,
      3/\xThursdayDayLetter,
      4/\xFridayDayLetter,
      5/\xSaturdayDayLetter,
      6/\xSundayDayLetter}
    {
      \addtocounter{verticalCount}{1}
      \ifnumgreater{\value{verticalCount}}{38}{\relax}{
	\setlength{\@tmp@a}{7\plannerGridColXShift}
	\setlength{\@tmp@a}{\i\@tmp@a + \j\plannerGridColXShift + \plannerGridMonthNamesWidth}

	% Day headings (top and bottom)

	\node [
	  right = \@tmp@a of bg.north west,
	  xshift = 0.5\plannerGridColXShift + 4pt,
	  yshift = -0.5\plannerGridDayHeadingsHeight - 5pt,
	  anchor = base,
	] {\plannerGridDateDayFmt \d};

	\node [
	  right = \@tmp@a of bg.south west,
	  xshift = 0.5\plannerGridColXShift + 4pt,
	  yshift = 0.5\plannerGridDayHeadingsHeight - 5pt,
	  anchor = base,
	] {\plannerGridDateDayFmt \d};

	% % Vertical lines

	% \node (v-a-\i-\j) [right = \@tmp@a of bg.north west] {};
	% \node (v-b-\i-\j) [right = \@tmp@a of bg.south west] {};
	% \draw [gridcolor] (v-a-\i-\j) -- (v-b-\i-\j);
      }
    }
  }

  \calendar (cal) [
    year planner landscape grid days,
    dates=\CalendarYear-01-01 to \CalendarYear-12-31,
    below right = 0pt and 0pt of bg.north west,
    anchor = north west,
    yshift = -\plannerGridDayHeadingsHeight - 3mm,
    xshift = \plannerGridMonthNamesWidth + 0.5\plannerGridColXShift + 4pt,
  ] \@wall@plmYear;

  \@wall@plNotesOneCalendar

\end{tikzpicture}%
}
\end{verbatim}

\section{\textbackslash YearPlannerLandscapeGridPage}
\label{sec:org7174f1d}

\begin{verbatim}
\newcommand{\YearPlannerLandscapeGridPage}{%
\pagecolor{pagebgcolor}%
\AddToShipoutPictureFG*{\put(\LenToUnit{\@wall@leftMargin},\LenToUnit{\@wall@bottomMargin})%
{\begin{minipage}[b]{\plannerGridCalendarWidth}%
\YearPlannerLandscapeGrid

\begin{minipage}[b][10mm][c]{\plannerGridCalendarWidth}%
\plannerGridNotesFmt
\hspace*{2mm}%
\parseYearEvents[%
  filter pred = hasNote,
  format cmd = {\textsuperscript{\eIdx}~\eMonthShort~\eDay:~\textit{\eNote}\ifnumless{\eIdx}{\eMaxIdx}{,\space}{.}},
]%
\end{minipage}%
\end{minipage}%
}}}
\end{verbatim}

\section{\textbackslash YearPlannerCompact}
\label{sec:org50b9fdc}

\begin{verbatim}
\newcommand\YearPlannerCompact{%
\@wall@usePlannerMoons%
\begin{tikzpicture}%
  \calendar (cal) [
    year planner compact,
    dates=\CalendarYear-01-01 to \CalendarYear-12-31,
  ] \@wall@plmYear;
  \@wall@plNotesOneCalendar
\end{tikzpicture}%
}
\end{verbatim}

\chapter{Title page}
\label{sec:org5dfd4f6}

\section{\textbackslash TitlePage}
\label{sec:orgfef7ef5}

\begin{verbatim}
% #1 : image path
% #3 : background overlay height
% #3 : title text
\newcommand{\TitlePage}[3]{%
\mbox{}
\thispagestyle{empty}

\AddToShipoutPictureFG*{%
  \put(\LenToUnit{-3mm},\LenToUnit{-3mm}){%
    \begin{tikzpicture}
      \node (bg) [
	minimum width=\calPaperWidth + 6mm,
	minimum height=\calPaperHeight + 6mm,
      ] {%
	\includegraphics[height={\calPaperHeight + 6mm}]{#1}%
      };

      \node (title-bg) [
	minimum width=\calPaperWidth + 6mm,
	minimum height=#2,
	above left=0pt and 0pt of bg.center,
	anchor=center,
	fill=white,
	opacity=0.4,
      ] {};

      \node (title-text) [
	above left=0pt and 0pt of bg.center,
	anchor=center,
      ] {%
	\begin{minipage}{\calPaperWidth + 6mm}%
	  \centering
	  #3%
	  \par
	\end{minipage}%
      };
    \end{tikzpicture}%
  }%
}%

}
\end{verbatim}

\chapter{Translation keys}
\label{sec:orgde00deb}

\begin{verbatim}
% Load internal translations
\InputIfFileExists{i18n/wallcalendar-\@wall@calendarLanguage.tex}{}%
{\ClassError{wallcalendar}{File Not Found: i18n/wallcalendar-\@wall@calendarLanguage.tex}{}}

% Load user translations if the option was set and translationsAutoload is true

\newcommand\LoadTranslations{%
\InputIfFileExists{\@wall@translationsInputFile}{}%
{\ClassWarning{wallcalendar}{File Not Found: \@wall@translationsInputFile}{}}}

\notblank{\@wall@translationsInputFile}{%
\iftranslationsAutoload \LoadTranslations \fi}
\end{verbatim}

Use \texttt{\textbackslash{}ifcase} instead of a \texttt{\textbackslash{}luadirect} array lookup, otherwise Portuguese day
headings such as \texttt{\textbackslash{}def\textbackslash{}xMondayDayLetter\{\{2\textbackslash{}textsuperscript\{a\}\}\}} cause an error.

\begin{verbatim}
#1 : month number, returns the translation
\end{verbatim}


\begin{verbatim}
\newcommand*\@tr@monthNumName[1]{%
\ifcase#1 \relax\or \xJanuary\or \xFebruary\or \xMarch\or \xApril\or \xMay\or \xJune\or
\xJuly\or \xAugust\or \xSeptember\or \xOctober\or \xNovember\or \xDecember\fi}
\end{verbatim}

\begin{verbatim}
#1 : weekday number, returns the one letter translation 
\end{verbatim}


\begin{verbatim}
\newcommand*\@tr@dayLetter[1]{%
\ifcase#1 \xMondayDayLetter\or \xTuesdayDayLetter\or \xWednesdayDayLetter\or
\xThursdayDayLetter\or \xFridayDayLetter\or \xSaturdayDayLetter\or \xSundayDayLetter\fi}
\end{verbatim}

\begin{verbatim}
\newcommand*\@tr@dayName[1]{%
\ifcase#1 \xMonday\or \xTuesday\or \xWednesday\or
\xThursday\or \xFriday\or \xSaturday\or \xSunday\fi}
\end{verbatim}

\chapter{Helper macros}
\label{sec:org43a83b1}

Doing this in Lua to make blasted sure the result is just a string

\begin{verbatim}
#1 : month name in English, returns zero padded number
\end{verbatim}


\begin{verbatim}
\newcommand*{\monthToNum}[1]{%
\luadirect{
  local monthToNum = {
    january   = '01',
    february  = '02',
    march     = '03',
    april     = '04',
    may       = '05',
    june      = '06',
    july      = '07',
    august    = '08',
    september = '09',
    october   = '10',
    november  = '11',
    december  = '12',
  }
  local key = string.lower('#1')
  tex.sprint(monthToNum[key])
}}
\end{verbatim}

\begin{verbatim}
#1 : month number, returns the name in English
\end{verbatim}


\begin{verbatim}
\newcommand*\monthName[1]{%
% \ifcase might be just fine here
\luadirect{
  local monthName = {
    'January', 'February', 'March', 'April', 'May', 'June', 'July',
    'August', 'September', 'October', 'November', 'December',
  }
  local key = tonumber('#1')
  tex.sprint(monthName[key])
}}
\end{verbatim}

\chapter{Epilogue}
\label{sec:orgc652671}

Running the calendar commands with empty arguments to make sure necessary
pgfkeys are defined.

This also avoids the problem that the user doesn't have to remember to declare
empty parts, such as having to call \texttt{\textbackslash{}SetQuote\{January\}\{\}} when he doesn't have
a quote.

Otherwise results in \texttt{Missing number} error when the user is building up the
calendar piece by piece.

\begin{verbatim}
! Missing number, treated as zero.
<to be read again>
\@val
l.19 ...out=full page, put photo=full page]{January}
\end{verbatim}


Repeating the months manually, \texttt{\textbackslash{}foreach} doesn't seem to work to set the month keys.

\begin{verbatim}
\SetPhoto{January}
\SetCalendar{January}
\SetQuote{January}{}
\SetEvents{January}{}{}

\SetPhoto{February}
\SetCalendar{February}
\SetQuote{February}{}
\SetEvents{February}{}{}

\SetPhoto{March}
\SetCalendar{March}
\SetQuote{March}{}
\SetEvents{March}{}{}

\SetPhoto{April}
\SetCalendar{April}
\SetQuote{April}{}
\SetEvents{April}{}{}

\SetPhoto{May}
\SetCalendar{May}
\SetQuote{May}{}
\SetEvents{May}{}{}

\SetPhoto{June}
\SetCalendar{June}
\SetQuote{June}{}
\SetEvents{June}{}{}

\SetPhoto{July}
\SetCalendar{July}
\SetQuote{July}{}
\SetEvents{July}{}{}

\SetPhoto{August}
\SetCalendar{August}
\SetQuote{August}{}
\SetEvents{August}{}{}

\SetPhoto{September}
\SetCalendar{September}
\SetQuote{September}{}
\SetEvents{September}{}{}

\SetPhoto{October}
\SetCalendar{October}
\SetQuote{October}{}
\SetEvents{October}{}{}

\SetPhoto{November}
\SetCalendar{November}
\SetQuote{November}{}
\SetEvents{November}{}{}

\SetPhoto{December}
\SetCalendar{December}
\SetQuote{December}{}
\SetEvents{December}{}{}
\end{verbatim}

\begin{verbatim}

% End of wallcalendar.cls
\end{verbatim}
\end{document}
